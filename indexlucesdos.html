<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Immersive & Lights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            background-image: linear-gradient(135deg, #0f172a, #101010);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
            position: relative;
            transition: none;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: inherit;
            background-size: inherit;
            background-position: inherit;
            z-index: -1;
            filter: blur(50px) brightness(0.6);
            transform: scale(1.2);
            transition: filter 0.5s ease, background-image 0.5s ease;
        }

        body.canvas-bg-active::before {
            background-image: none !important;
            filter: none !important;
        }

        #canvas-bg-video {
            opacity: 0;
            transition: opacity 0.5s ease, filter 0.5s ease;
            filter: blur(50px) brightness(0.6);
            transform: scale(1.2);
            pointer-events: none;
        }

        #canvas-cover-video { object-fit: cover; }

        .progress-bar {
            transition: transform 0.5s linear, background-color 0.5s ease, box-shadow 0.5s ease;
            transform-origin: left;
            will-change: transform;
            background-color: #1DB954;
            box-shadow: 0 0 10px #1DB954;
            backface-visibility: hidden;
        }

        .glassmorphism {
            background: rgba(25, 25, 35, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease, box-shadow 0.3s ease, color 0.3s ease, border-color 0.3s ease, backdrop-filter 0.3s ease;
        }

        .control-button:hover {
            box-shadow: 0 0 20px rgba(30, 215, 96, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- ESTILOS DE MODOS DE LUCES --- */
        .light-mode-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .light-mode-card.active {
            border-color: #1DB954;
            background: rgba(29, 185, 84, 0.1);
            box-shadow: 0 0 15px rgba(29, 185, 84, 0.3);
        }
        .light-mode-icon {
            transition: transform 0.3s ease;
        }
        .light-mode-card:hover .light-mode-icon {
            transform: scale(1.1);
        }
        
        /* --- Resto de estilos del reproductor --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .fade-in-up { animation: fadeIn 0.6s ease-out forwards; will-change: transform, opacity; }

        .album-cover-container {
            position: relative; cursor: pointer;
            transition: width 0.4s ease-in-out, height 0.4s ease-in-out, margin 0.4s ease-in-out;
            width: 16rem; height: 16rem;
        }
        @media (min-width: 768px) { .album-cover-container { width: 14rem; height: 14rem; } }
        @media (min-width: 1024px) { .album-cover-container { width: 16rem; height: 16rem; } }

        #album-cover { border: 2px solid transparent; transition: border-color 0.5s ease, transform 0.3s ease, filter 0.3s ease, opacity 0.3s ease; }
        #album-cover-container:hover #album-cover { transform: scale(1.02); filter: brightness(1.1); }
        .text-shadow { text-shadow: 0 2px 8px rgba(0,0,0,0.7); }
        
        .modal, .popover { transition: opacity 0.3s ease-in-out; }
        .modal-card { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .modal.hidden .modal-card { transform: scale(0.95) translateY(10px); opacity: 0; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; appearance: none; background: rgba(255, 255, 255, 0.3); border-radius: 2px; height: 4px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; transition: transform .2s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* Immersive Mode Overrides */
        #app.theme-immersive #player { flex-direction: column !important; align-items: center !important; padding: 2rem 1rem; max-width: 90vw; width: auto; height: auto; gap: 0; }
        #app.theme-immersive .glassmorphism { background: transparent; backdrop-filter: none; border: none; box-shadow: none; padding: 0; }
        #app.theme-immersive #album-cover-container { width: 75vw !important; height: 75vw !important; max-width: 350px !important; max-height: 350px !important; margin-bottom: 2rem !important; }
        #app.theme-immersive .flex.flex-col.w-full { text-align: center !important; width: 100%; max-width: 500px; padding: 0; align-items: center; }
        #app.theme-immersive #song-title-container { justify-content: center !important; }
        #app.theme-immersive #open-menu-button { display: none; }

        /* Toast */
        #toast { transition: transform 0.5s ease, opacity 0.5s ease; transform: translateY(150%); opacity: 0; }
        #toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body id="body" class="p-4">

    <!-- Video Background -->
    <video id="canvas-bg-video" class="fixed inset-0 w-full h-full object-cover -z-[2]" autoplay loop muted playsinline></video>
    
    <!-- Canvas Helper for Light Analysis -->
    <canvas id="light-analysis-canvas" width="50" height="50" class="hidden"></canvas>

    <div id="transition-overlay" class="fixed inset-0" style="background: linear-gradient(135deg, #0f172a, #101010); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.4s ease-in-out;"></div>

    <div class="flex justify-center items-center w-full">
        <div id="app" class="w-full max-w-sm sm:max-w-md md:max-w-4xl">

            <!-- Login View -->
            <div id="login" class="flex flex-col items-center fade-in-up">
                <h1 class="text-4xl md:text-5xl font-black mb-2 tracking-tighter text-shadow">Now Playing</h1>
                <p class="text-lg text-gray-300 mb-8">Conecta tu cuenta para empezar</p>
                <button id="login-button" class="glassmorphism flex items-center justify-center text-white font-bold px-8 py-3 rounded-full transition-all duration-300 md:text-lg">
                    Conectar con Spotify
                </button>
            </div>

            <!-- Player View -->
            <div id="player" class="hidden glassmorphism p-6 md:p-8 rounded-2xl fade-in-up flex flex-col md:flex-row md:items-center md:gap-8">
                <div id="album-cover-container" class="album-cover-container relative mb-6 md:mb-0 flex-shrink-0" title="Cambiar tema">
                    <img id="album-cover" class="absolute inset-0 w-full h-full rounded-xl shadow-2xl object-cover" src="" alt="Carátula" crossorigin="anonymous">
                    <video id="canvas-cover-video" class="hidden absolute inset-0 w-full h-full rounded-xl shadow-2xl object-cover" autoplay loop muted playsinline></video>
                </div>

                <div class="flex flex-col w-full text-center md:text-left">
                    <div id="song-title-container" class="flex items-center justify-center md:justify-start gap-3 mb-2">
                        <h2 id="song-title" class="text-2xl md:text-4xl font-bold tracking-tight text-shadow">Cargando...</h2>
                        <button id="song-lyrics-button" title="Ver Letra" class="hidden control-button glassmorphism p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18.5a9.2 9.2 0 0 1-2.2.5 8.5 8.5 0 0 1-8.3-8.3A8.5 8.5 0 0 1 15 2.2a9 9 0 0 1 .5 2.3m-3.5 1.5a.5.5 0 0 0 0-1H10a.5.5 0 0 0 0 1h2zm-2-3a.5.5 0 0 0 0-1H10a.5.5 0 0 0 0 1h2z"/><path d="M11 18.2a1 1 0 0 1-.7-.3l-4-4a1 1 0 0 1 1.4-1.4l4 4a1 1 0 0 1-.7 1.7z"/></svg>
                        </button>
                    </div>
                    <p id="song-artist" class="text-lg md:text-xl text-gray-300 mb-6 text-shadow">Cargando...</p>

                    <div id="progress-container" class="w-full bg-white/10 rounded-full h-2 mb-2 overflow-hidden cursor-pointer">
                        <div id="progress-bar" class="progress-bar h-2 w-full"></div>
                    </div>
                    <div class="w-full flex justify-between text-sm md:text-base text-gray-400 mb-6">
                        <span id="time-current">0:00</span>
                        <span id="time-total">0:00</span>
                    </div>

                    <div class="relative flex items-center self-center md:self-start gap-2">
                        <button id="open-menu-button" title="Menú Principal" class="control-button glassmorphism p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </button>
                        
                        <!-- NUEVO BOTÓN DE LUCES -->
                        <button id="open-lights-button" title="Control de Luces" class="control-button glassmorphism p-3 rounded-full text-yellow-400 hover:text-yellow-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.9.27-1.85.26-2.83a7.35 7.35 0 0 0-3.17-5.9 7 7 0 0 0-8.36.19 7.35 7.35 0 0 0-3.15 6 7.63 7.63 0 0 0 2.26 5.34l.2.18"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONTROL DE LUCES (NUEVO) -->
    <div id="lights-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-lg flex flex-col relative">
            <button id="close-lights-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-center flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .3-2 .3-3 .5-3-2-6-5-6s-5.5 3-5 6c0 1 .1 2 .3 3"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                Control de Luces
            </h3>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Modo Estático -->
                <div class="light-mode-card cursor-pointer p-4 rounded-xl bg-white/5 hover:bg-white/10 flex flex-col items-center gap-2 text-center" data-mode="static">
                    <svg class="light-mode-icon text-blue-400" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span class="font-bold">Estático</span>
                    <span class="text-xs text-gray-400">Color fijo de la carátula</span>
                </div>

                <!-- Modo Dinámico -->
                <div class="light-mode-card cursor-pointer p-4 rounded-xl bg-white/5 hover:bg-white/10 flex flex-col items-center gap-2 text-center" data-mode="dynamic">
                    <svg class="light-mode-icon text-purple-400" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span class="font-bold">Dinámico</span>
                    <span class="text-xs text-gray-400">Sigue el video/Canvas</span>
                </div>

                <!-- Modo Fiesta -->
                <div class="light-mode-card cursor-pointer p-4 rounded-xl bg-white/5 hover:bg-white/10 flex flex-col items-center gap-2 text-center" data-mode="party">
                    <svg class="light-mode-icon text-pink-500" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                    <span class="font-bold">Fiesta</span>
                    <span class="text-xs text-gray-400">Cambio rápido aleatorio</span>
                </div>

                <!-- Modo Apagar -->
                <div class="light-mode-card cursor-pointer p-4 rounded-xl bg-white/5 hover:bg-white/10 flex flex-col items-center gap-2 text-center" data-mode="off">
                    <svg class="light-mode-icon text-gray-400" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                    <span class="font-bold">Apagar</span>
                    <span class="text-xs text-gray-400">Desactiva las luces</span>
                </div>
            </div>

            <div class="bg-white/5 p-4 rounded-xl">
                <p class="text-sm text-gray-400 mb-2">Estado del Proxy:</p>
                <div class="flex items-center gap-2">
                    <div id="proxy-status-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span id="proxy-status-text" class="text-sm font-mono">Desconectado (Check https://localhost:9999)</span>
                </div>
                <button id="test-lights-btn" class="mt-3 w-full bg-white/10 hover:bg-white/20 text-xs py-2 rounded transition-colors">Probar conexión ahora</button>
            </div>
        </div>
    </div>

    <!-- Modals de Menú (Manteniendo los existentes) -->
    <div id="menu-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <!-- (Contenido del menú original mantenido para funcionalidad) -->
        <div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col relative">
            <button id="close-menu-modal-x" class="absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h3 class="text-2xl font-bold mb-4 text-center">Menú</h3>
            <div class="flex flex-col gap-2">
                <button id="menu-lights-shortcut" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10 bg-white/5 text-yellow-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .3-2 .3-3 .5-3-2-6-5-6s-5.5 3-5 6c0 1 .1 2 .3 3"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                    Configurar Luces
                </button>
                <button id="menu-logout" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10 text-red-400 mt-4 border-t border-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </div>

    <!-- Otros modales (Lyrics, etc.) -->
    <div id="lyrics-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Letra</h3>
                <button id="close-lyrics-modal" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div id="lyrics-content" class="custom-scrollbar overflow-y-auto flex-grow text-center text-lg leading-relaxed text-gray-200">Cargando...</div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 glassmorphism py-3 px-5 rounded-lg shadow-xl z-[100]">
        <p id="toast-message"></p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '31e070e9a8fa4e87a5ddb69bba539dde';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-read-playback-state user-modify-playback-state user-read-recently-played user-read-currently-playing playlist-read-private playlist-read-collaborative';
        const PROXY_URL = 'https://localhost:9999/yeelight'; // URL de tu proxy local

        // --- DOM Elements ---
        const ui = {
            body: document.getElementById('body'),
            appContainer: document.getElementById('app'),
            loginButton: document.getElementById('login-button'),
            playerView: document.getElementById('player'),
            albumCover: document.getElementById('album-cover'),
            canvasBgVideo: document.getElementById('canvas-bg-video'),
            progressBar: document.getElementById('progress-bar'),
            songTitle: document.getElementById('song-title'),
            songArtist: document.getElementById('song-artist'),
            openLightsButton: document.getElementById('open-lights-button'),
            lightsModal: document.getElementById('lights-modal'),
            closeLightsModal: document.getElementById('close-lights-modal'),
            lightModeCards: document.querySelectorAll('.light-mode-card'),
            testLightsBtn: document.getElementById('test-lights-btn'),
            proxyStatusIndicator: document.getElementById('proxy-status-indicator'),
            proxyStatusText: document.getElementById('proxy-status-text'),
            lightAnalysisCanvas: document.getElementById('light-analysis-canvas'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            // ... (Rest of DOM elements for lyrics/menu kept implicitly)
            openMenuButton: document.getElementById('open-menu-button'),
            menuModal: document.getElementById('menu-modal'),
            closeMenuModal: document.getElementById('close-menu-modal-x'),
            menuLightsShortcut: document.getElementById('menu-lights-shortcut'),
            menuLogout: document.getElementById('menu-logout'),
            songLyricsButton: document.getElementById('song-lyrics-button'),
            lyricsModal: document.getElementById('lyrics-modal'),
            closeLyricsModal: document.getElementById('close-lyrics-modal'),
            lyricsContent: document.getElementById('lyrics-content'),
        };

        // --- APP STATE ---
        let state = {
            currentSongId: null,
            currentVolume: 100,
            lightMode: localStorage.getItem('spotifyLightMode') || 'static', // static, dynamic, party, off
            lastSentColor: null,
            lightInterval: null, // For dynamic/party loops
            colorThief: new ColorThief(),
            isProxyConnected: false
        };

        // --- AUTH & SPOTIFY API (Simplificado para brevedad, igual que antes) ---
        async function redirectToSpotifyAuth() {
            const verifier = generateCodeVerifier();
            sessionStorage.setItem('code_verifier', verifier);
            const params = new URLSearchParams({ response_type: 'code', client_id: CLIENT_ID, scope: SCOPES, redirect_uri: REDIRECT_URI, code_challenge_method: 'S256', code_challenge: await generateCodeChallenge(verifier) });
            window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }
        function generateCodeVerifier() { const a=new Uint8Array(32); crypto.getRandomValues(a); return Array.from(a,b=>('0'+b.toString(16)).slice(-2)).join(''); }
        async function generateCodeChallenge(v) { const d=new TextEncoder().encode(v); const dg=await crypto.subtle.digest('SHA-256', d); return btoa(String.fromCharCode(...new Uint8Array(dg))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }

        async function spotifyApiRequest(endpoint, method = 'GET', body = null) {
            const token = sessionStorage.getItem('access_token');
            if(!token) return null;
            const res = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: body ? JSON.stringify(body) : null
            });
            if(res.status === 401) { sessionStorage.clear(); location.reload(); }
            if(res.status === 204) return null;
            return res.json();
        }

        // --- LIGHTS LOGIC (LO NUEVO) ---
        
        function initLightsUI() {
            // Set active class on load
            ui.lightModeCards.forEach(card => {
                card.classList.toggle('active', card.dataset.mode === state.lightMode);
                card.addEventListener('click', () => setLightMode(card.dataset.mode));
            });
            startLightLoop(); // Start logic
            checkProxyConnection();
        }

        function setLightMode(mode) {
            state.lightMode = mode;
            localStorage.setItem('spotifyLightMode', mode);
            
            // UI Update
            ui.lightModeCards.forEach(card => card.classList.toggle('active', card.dataset.mode === mode));
            
            showToast(`Modo Luces: ${mode.toUpperCase()}`);
            
            // Logic Restart
            startLightLoop();
        }

        function startLightLoop() {
            if(state.lightInterval) clearInterval(state.lightInterval);

            if (state.lightMode === 'off') {
                sendColorToProxy([0,0,0]); // Send Black (Off)
                return;
            }

            if (state.lightMode === 'static') {
                // Triggered once on song change, forcing it now
                if(ui.albumCover.src && !ui.albumCover.src.includes('placehold')) {
                    try {
                        const color = state.colorThief.getColor(ui.albumCover);
                        sendColorToProxy(color);
                    } catch(e) {}
                }
            }

            if (state.lightMode === 'party') {
                state.lightInterval = setInterval(() => {
                    // Random bright color
                    const r = Math.floor(Math.random() * 255);
                    const g = Math.floor(Math.random() * 255);
                    const b = Math.floor(Math.random() * 255);
                    sendColorToProxy([r,g,b]);
                }, 600); // Fast change
            }

            if (state.lightMode === 'dynamic') {
                // Sample video or album every second
                state.lightInterval = setInterval(() => {
                    sampleDynamicColor();
                }, 2000); // Smoother transition time
            }
        }

        function sampleDynamicColor() {
            // Intenta muestrear el video de fondo si está activo
            if (ui.canvasBgVideo.readyState === 4 && ui.canvasBgVideo.style.opacity !== '0') {
                try {
                    const ctx = ui.lightAnalysisCanvas.getContext('2d');
                    ctx.drawImage(ui.canvasBgVideo, 0, 0, 50, 50);
                    // Sample center pixel
                    const p = ctx.getImageData(25, 25, 1, 1).data;
                    // If not black
                    if(p[0] > 10 || p[1] > 10 || p[2] > 10) {
                        sendColorToProxy([p[0], p[1], p[2]]);
                        return;
                    }
                } catch(e) {
                    // CORS might block video sampling, fallback to palette
                }
            }
            
            // Fallback: Cycle album palette
            if(ui.albumCover.complete && ui.albumCover.naturalWidth > 0) {
                try {
                    const palette = state.colorThief.getPalette(ui.albumCover, 5);
                    if(palette && palette.length > 0) {
                        const randomIndex = Math.floor(Math.random() * Math.min(palette.length, 3));
                        sendColorToProxy(palette[randomIndex]);
                    }
                } catch(e) {}
            }
        }

        async function sendColorToProxy(rgb) {
            if(!rgb) return;
            // Debounce same color
            if(state.lastSentColor && state.lastSentColor[0] === rgb[0] && state.lastSentColor[1] === rgb[1] && state.lastSentColor[2] === rgb[2]) return;
            state.lastSentColor = rgb;

            const rgbValue = (rgb[0] << 16) | (rgb[1] << 8) | rgb[2];
            const payload = {
                ip: "0.0.0.0", port: 0,
                command: { id: 1, method: 'set_rgb', params: [rgbValue, 'smooth', 500] }
            };

            try {
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if(res.ok) {
                    ui.proxyStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    ui.proxyStatusText.textContent = 'Conectado';
                }
            } catch(e) {
                ui.proxyStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                ui.proxyStatusText.textContent = 'Error de conexión';
            }
        }

        async function checkProxyConnection() {
            try {
                // Check if we can reach the test endpoint or just ping
                await fetch(PROXY_URL.replace('/yeelight', '/test'), { method: 'GET' });
                ui.proxyStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                ui.proxyStatusText.textContent = 'Conectado';
            } catch(e) {
                console.log('Proxy check failed');
            }
        }


        // --- MAIN APP LOGIC ---
        function updateUI(data) {
            if(!data || !data.item) {
                ui.songTitle.textContent = "Nada sonando";
                ui.songArtist.textContent = "Pon música en Spotify";
                ui.albumCover.src = "https://placehold.co/300x300/222/fff?text=Spotify";
                return;
            }

            const track = data.item;
            
            // Update Text
            if(ui.songTitle.textContent !== track.name) {
                ui.songTitle.textContent = track.name;
                ui.songArtist.textContent = track.artists.map(a => a.name).join(', ');
                
                // Update Cover & Colors
                const imgUrl = track.album.images[0].url;
                if(ui.albumCover.src !== imgUrl) {
                    ui.albumCover.src = imgUrl;
                    ui.albumCover.onload = () => {
                        // Background gradient logic
                        try {
                            const color = state.colorThief.getColor(ui.albumCover);
                            ui.progressBar.style.backgroundColor = `rgb(${color.join(',')})`;
                            ui.progressBar.style.boxShadow = `0 0 10px rgb(${color.join(',')})`;
                            
                            // LIGHTS: If Static Mode, send color now
                            if (state.lightMode === 'static') {
                                sendColorToProxy(color);
                            }
                        } catch(e) {}
                    }
                    
                    // Fetch Canvas (Video)
                    fetchCanvas(track.id);
                }
            }

            // Progress Bar
            const progress = (data.progress_ms / track.duration_ms) * 100;
            ui.progressBar.style.transform = `scaleX(${progress/100})`;
            document.getElementById('time-current').textContent = formatTime(data.progress_ms);
            document.getElementById('time-total').textContent = formatTime(track.duration_ms);
        }

        async function fetchCanvas(trackId) {
            // Using Spoticanvas API
            try {
                const res = await fetch(`https://spoticanvasapi-three.vercel.app/api/canvas?trackId=${trackId}`);
                const data = await res.json();
                if(data.canvasesList && data.canvasesList.length > 0) {
                    ui.canvasBgVideo.src = data.canvasesList[0].canvasUrl;
                    ui.canvasBgVideo.style.opacity = '1';
                    ui.body.classList.add('canvas-bg-active');
                } else {
                    ui.canvasBgVideo.style.opacity = '0';
                    ui.body.classList.remove('canvas-bg-active');
                }
            } catch(e) {
                ui.canvasBgVideo.style.opacity = '0';
            }
        }

        async function fetchCurrentTrack() {
            const data = await spotifyApiRequest('/me/player/currently-playing?market=ES');
            updateUI(data);
        }

        function formatTime(ms) { const s = Math.floor(ms / 1000); return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; }
        function showToast(msg) { ui.toastMessage.textContent = msg; ui.toast.classList.add('show'); setTimeout(() => ui.toast.classList.remove('show'), 3000); }

        // --- EVENTS ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.has('code')) {
                // Auth Code Flow
                const code = params.get('code');
                const verifier = sessionStorage.getItem('code_verifier');
                fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code, redirect_uri: REDIRECT_URI, code_verifier: verifier })
                }).then(r => r.json()).then(d => {
                    sessionStorage.setItem('access_token', d.access_token);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    location.reload();
                });
            } else if(sessionStorage.getItem('access_token')) {
                document.getElementById('login').classList.add('hidden');
                document.getElementById('player').classList.remove('hidden');
                setInterval(fetchCurrentTrack, 1000);
                fetchCurrentTrack();
                initLightsUI();
            }

            ui.loginButton.onclick = redirectToSpotifyAuth;
            ui.openLightsButton.onclick = () => ui.lightsModal.classList.remove('hidden');
            ui.closeLightsModal.onclick = () => ui.lightsModal.classList.add('hidden');
            ui.testLightsBtn.onclick = () => { window.open(PROXY_URL.replace('/yeelight', '/test'), '_blank'); };
            
            // Menu
            ui.openMenuButton.onclick = () => ui.menuModal.classList.remove('hidden');
            ui.closeMenuModal.onclick = () => ui.menuModal.classList.add('hidden');
            ui.menuLightsShortcut.onclick = () => { ui.menuModal.classList.add('hidden'); ui.lightsModal.classList.remove('hidden'); };
            ui.menuLogout.onclick = () => { sessionStorage.clear(); location.reload(); };

            // Lyrics
            ui.songLyricsButton.onclick = () => ui.lyricsModal.classList.remove('hidden');
            ui.closeLyricsModal.onclick = () => ui.lyricsModal.classList.add('hidden');
        };
    </script>
</body>
</html>
