<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #1DB954;
            --primary-dark: #1aa34a;
            --glass-bg: rgba(25, 25, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: 20px;
        }

        body {
            background-image: linear-gradient(135deg, #0f172a, #101010);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
            position: relative;
            transition: none;
        }

        /* Smooth Background Transition */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: inherit;
            background-size: inherit;
            background-position: inherit;
            z-index: -2;
            filter: blur(60px) brightness(0.5) saturate(1.2);
            transform: scale(1.2) translate3d(0,0,0);
            transition: filter 1s ease, background-image 1s ease;
        }

        body.canvas-bg-active::before { opacity: 0; }

        #canvas-bg-video {
            opacity: 0;
            transition: opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: blur(50px) brightness(0.6);
            transform: scale(1.1) translate3d(0, 0, 0); 
            will-change: opacity, transform; 
            pointer-events: none;
            object-fit: cover;
        }

        /* --- GLASSMORPHISM & CARDS --- */
        .glassmorphism {
            background: rgba(30, 30, 40, 0.7);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
        @keyframes listEnter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        
        .menu-stagger-item { opacity: 0; animation: listEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .menu-stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .menu-stagger-item:nth-child(2) { animation-delay: 0.1s; }
        .menu-stagger-item:nth-child(3) { animation-delay: 0.15s; }
        .menu-stagger-item:nth-child(4) { animation-delay: 0.2s; }
        .menu-stagger-item:nth-child(5) { animation-delay: 0.25s; }

        /* --- UI ELEMENTS --- */
        .progress-bar {
            transition: transform 0.2s linear, background-color 0.5s ease, box-shadow 0.5s ease;
            transform-origin: left;
            background-color: var(--primary);
            box-shadow: 0 0 15px rgba(29, 185, 84, 0.6);
            height: 100%; border-radius: 999px;
        }

        .control-button { transition: all 0.2s ease; }
        .control-button:hover { transform: scale(1.1); background: rgba(255, 255, 255, 0.15); }
        .control-button:active { transform: scale(0.95); }

        .album-cover-container {
            position: relative; cursor: pointer; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 16rem; height: 16rem; flex-shrink: 0; perspective: 1000px;
        }
        @media (min-width: 768px) { .album-cover-container { width: 15rem; height: 15rem; } }
        @media (min-width: 1024px) { .album-cover-container { width: 18rem; height: 18rem; } }

        #album-cover { transition: transform 0.4s ease, filter 0.4s ease; border-radius: 12px; }
        .album-cover-container:hover #album-cover { transform: scale(1.03) translateY(-5px); filter: brightness(1.1); }

        /* --- MODALS & MENUS --- */
        .modal { transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .modal-card { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal.hidden .modal-card { transform: scale(0.9) translateY(20px); opacity: 0; }
        
        .menu-list-item {
            padding: 12px 16px; margin-bottom: 4px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; gap: 12px; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
        }
        .menu-list-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(4px); }
        .menu-list-item.active { background: rgba(29, 185, 84, 0.15); color: var(--primary); font-weight: 600; border-color: rgba(29, 185, 84, 0.2); }

        .menu-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.4); margin: 16px 0 8px 12px; font-weight: 700; }
        .menu-tabs-container { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; display: flex; margin-bottom: 16px; }
        .menu-tab-button { flex: 1; padding: 8px; border-radius: 8px; color: rgba(255, 255, 255, 0.6); transition: all 0.3s ease; font-size: 0.9rem; font-weight: 500; }
        .menu-tab-button.active { background: rgba(255, 255, 255, 0.1); color: white; font-weight: 600; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* --- SPECIAL MODES (Side/Cover) --- */
        #app.lyrics-mode-side { width: 100vw; height: 100vh; max-width: none; margin: 0; padding: 0; }
        #app.lyrics-mode-side #player { 
            width: 100%; height: 100%; padding: 0 4rem; 
            justify-content: center; gap: 4rem; background: transparent; border: none; 
        }
        #app.lyrics-mode-side #album-cover-container {
            width: 40vw; height: 40vw; max-width: 500px; max-height: 500px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        #app.lyrics-mode-side .lyric-word { font-size: 2.5rem; }
        
        @media (max-width: 1024px) {
            #app.lyrics-mode-side #player { flex-direction: column; padding: 2rem; gap: 2rem; }
            #app.lyrics-mode-side #album-cover-container { width: 60vw; height: 60vw; }
            #app.lyrics-mode-side .lyric-word { font-size: 1.8rem; }
        }

        /* Lyrics Typography */
        .lyric-line { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; transition: opacity 0.3s ease; }
        #app.lyrics-mode-side .lyric-line { justify-content: flex-start; text-align: left; }
        
        .lyric-word {
            font-size: 1.8rem; font-weight: 800; line-height: 1.3; margin: 0 0.2em; cursor: pointer;
            color: rgba(255, 255, 255, 0.25);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), color 0.3s ease, text-shadow 0.3s ease;
            background-image: linear-gradient(90deg, #fff calc(var(--word-progress, 0%) - 5%), rgba(255,255,255,0.25) calc(var(--word-progress, 0%) + 5%));
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .lyric-word.active { transform: scale(1.15) translateY(-2px); text-shadow: 0 0 20px rgba(255,255,255,0.4); opacity: 1; }
        .lyric-word.played { color: #fff; opacity: 1; transform: scale(1); --word-progress: 150%; }

        /* --- TOAST --- */
        #toast { transform: translateY(150%) scale(0.9); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #toast.show { transform: translateY(0) scale(1); opacity: 1; }

    </style>
</head>
<body id="body" class="p-4 selection:bg-green-500 selection:text-white">

    <!-- Background Video -->
    <video id="canvas-bg-video" class="fixed inset-0 w-full h-full object-cover -z-[2]" autoplay loop muted playsinline preload="auto"></video>
    <div class="fixed inset-0 bg-black/30 pointer-events-none -z-[1]"></div>

    <!-- Login / Landing -->
    <div id="login" class="fixed inset-0 z-[100] bg-[#0f172a] flex flex-col hidden">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1614149162883-504ce4d13909?q=80&w=2574&auto=format&fit=crop')] bg-cover bg-center opacity-30"></div>
        <div class="relative z-10 flex flex-col items-center justify-center flex-1 p-6 text-center">
            <div class="animate-float mb-8">
                <svg class="w-24 h-24 text-[#1DB954] drop-shadow-[0_0_20px_rgba(29,185,84,0.5)]" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 5.523 4.477 10 10 10s10-4.477 10-10c0-5.523-4.477-10-10-10zm4.587 14.418c-.183.3-.572.396-.874.213-2.393-1.463-5.405-1.794-8.955-.983-.334.076-.667-.14-.742-.475-.077-.333.14-.666.474-.74 3.905-.893 7.257-.52 9.883 1.085.3.183.4.57.213.874zm1.248-2.775c-.23.376-.723.498-1.1.267-2.68-1.647-6.764-2.124-9.93-1.163-.418.127-.856-.11-.983-.526-.126-.418.11-.856.527-.983 3.633-1.103 8.163-.564 11.22 1.31.375.228.497.72.266 1.1zm.106-2.924c-3.21-1.905-8.506-2.08-11.57-1.15-.465.14-.956-.12-1.096-.587-.14-.464.12-.955.587-1.094 3.538-1.074 9.387-.866 13.048 1.306.417.247.553.784.305 1.202-.247.417-.784.553-1.2.306z"/></svg>
            </div>
            <h1 class="text-6xl font-black mb-4 tracking-tighter drop-shadow-lg">Now Playing</h1>
            <p class="text-xl text-gray-300 mb-10 font-light max-w-md">Visualizador inmersivo con letras sincronizadas y fondos dinámicos.</p>
            <button id="login-button" class="group relative px-10 py-4 bg-[#1DB954] hover:bg-[#1ed760] text-black font-bold rounded-full text-lg transition-all transform hover:scale-105 shadow-[0_0_30px_rgba(29,185,84,0.4)] flex items-center gap-3 overflow-hidden">
                 <span class="relative z-10">Conectar Spotify</span>
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="flex justify-center items-center w-full min-h-screen">
        <div id="app" class="w-full max-w-sm sm:max-w-md md:max-w-4xl transition-all duration-500 relative theme-glass">
            
            <!-- Side Mode Controls -->
            <div class="fixed top-6 right-6 z-[60] flex gap-3">
                <button id="side-settings-btn" class="hidden control-button bg-black/40 backdrop-blur-md p-3 rounded-full border border-white/10" title="Ajustes">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="exit-side-mode-btn" class="hidden control-button bg-black/40 backdrop-blur-md p-3 rounded-full border border-white/10 text-white" title="Salir">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <!-- Player Card -->
            <div id="player" class="hidden glassmorphism p-8 md:p-10 rounded-3xl fade-in-up flex flex-col md:flex-row md:items-center md:gap-10 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>

                <!-- Album Art Column -->
                <div id="album-cover-container" class="album-cover-container mx-auto md:mx-0 mb-8 md:mb-0 shadow-2xl rounded-2xl">
                    <img id="album-cover" class="absolute inset-0 w-full h-full rounded-2xl object-cover" src="" alt="Album Art" crossorigin="anonymous">
                    <video id="canvas-cover-video" class="hidden absolute inset-0 w-full h-full rounded-2xl object-cover" autoplay loop muted playsinline preload="auto"></video>
                    
                    <!-- Cover Lyrics Overlay -->
                    <div id="lyrics-cover-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-md z-10 rounded-2xl flex flex-col opacity-0 pointer-events-none transition-opacity duration-300">
                        <div id="lyrics-cover-content" class="h-full w-full overflow-y-auto px-4 py-10 text-center custom-scrollbar mask-gradient"></div>
                    </div>

                    <!-- Side Mode Track Info -->
                    <div id="side-track-info" class="absolute top-full inset-x-0 mt-8 text-center hidden">
                        <h2 id="side-track-title" class="text-4xl font-black text-shadow mb-2 leading-tight"></h2>
                        <p id="side-track-artist" class="text-2xl text-gray-300 text-shadow font-medium"></p>
                    </div>
                </div>

                <!-- Controls & Info Column -->
                <div class="flex flex-col w-full text-center md:text-left flex-1 min-w-0 z-10">
                    
                    <!-- Side Mode Lyrics Container -->
                    <div id="lyrics-side-container" class="hidden h-full w-full relative mask-gradient">
                        <div id="lyrics-side-content" class="h-full w-full overflow-y-auto custom-scrollbar flex flex-col items-start py-[50vh]"></div>
                    </div>

                    <!-- Standard Info -->
                    <div id="standard-info">
                        <div id="song-title-container" class="flex items-center justify-center md:justify-start gap-3 mb-1">
                            <h2 id="song-title" class="text-3xl font-bold tracking-tight text-shadow truncate">Cargando...</h2>
                            <button id="song-lyrics-button" class="control-button hidden p-2 rounded-full bg-white/5 hover:bg-white/20" title="Ver Letra">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                            </button>
                        </div>
                        <p id="song-artist" class="text-xl text-gray-300 mb-8 font-medium truncate">...</p>

                        <div id="progress-container" class="w-full bg-white/10 rounded-full h-1.5 mb-2 cursor-pointer group hover:h-2.5 transition-all">
                            <div id="progress-bar" class="progress-bar relative"></div>
                        </div>
                        <div class="flex justify-between text-xs font-medium text-gray-400 mb-8 tracking-wider">
                            <span id="time-current">0:00</span>
                            <span id="time-total">0:00</span>
                        </div>

                        <div class="flex items-center justify-center md:justify-start">
                            <button id="open-menu-button" class="control-button glassmorphism px-6 py-3 rounded-full flex items-center gap-3 font-semibold text-sm tracking-wide">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                                MENU
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN MENU MODAL -->
    <div id="menu-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-md flex flex-col max-h-[85vh] overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold tracking-tight">Control Center</h3>
                <button id="close-menu-modal-x" class="p-2 rounded-full hover:bg-white/10 transition-colors"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="menu-tabs-container">
                <button class="menu-tab-button active" data-tab="menu-tab-actions">Acciones</button>
                <button class="menu-tab-button" data-tab="menu-tab-lists">Biblioteca</button>
                <button class="menu-tab-button" data-tab="menu-tab-devices">Dispositivos</button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1">
                <div id="menu-tab-actions" class="menu-tab-content flex flex-col gap-1">
                    <p class="menu-section-title">Visualización</p>
                    <div id="menu-lyrics" class="menu-list-item menu-stagger-item">
                        <div class="bg-purple-500/20 p-2 rounded-lg text-purple-300"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg></div>
                        <span class="flex-1 font-medium">Letras y Modos</span>
                    </div>
                    <div id="menu-background-settings" class="menu-list-item menu-stagger-item">
                        <div class="bg-blue-500/20 p-2 rounded-lg text-blue-300"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                        <span class="flex-1 font-medium">Fondo y Canvas</span>
                    </div>
                    <div id="menu-kiosk" class="menu-list-item menu-stagger-item">
                        <div class="bg-orange-500/20 p-2 rounded-lg text-orange-300"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></div>
                        <span class="flex-1 font-medium">Pantalla Completa (Kiosco)</span>
                    </div>
                    <p class="menu-section-title mt-4">General</p>
                    <div id="menu-search" class="menu-list-item menu-stagger-item">
                         <div class="bg-gray-500/20 p-2 rounded-lg text-gray-300"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                        <span class="flex-1 font-medium">Buscar en Spotify</span>
                    </div>
                    <div class="menu-list-item menu-stagger-item cursor-default hover:bg-transparent hover:translate-x-0">
                         <div class="bg-green-500/20 p-2 rounded-lg text-green-300"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg></div>
                        <div class="flex-1 flex flex-col gap-1">
                            <span class="font-medium text-sm">Volumen</span>
                            <input type="range" id="menu-volume-slider" min="0" max="100">
                        </div>
                    </div>
                    <div class="h-px bg-white/10 my-2"></div>
                    <div id="menu-logout" class="menu-list-item menu-stagger-item text-red-400 hover:text-red-300 hover:bg-red-500/10">
                        <div class="p-2"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></div>
                        <span class="font-medium">Cerrar Sesión</span>
                    </div>
                </div>
                <!-- Lists Tab -->
                <div id="menu-tab-lists" class="menu-tab-content hidden flex flex-col gap-1">
                    <div id="menu-queue" class="menu-list-item menu-stagger-item">
                        <div class="bg-white/10 p-2 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line></svg></div>
                        <span class="flex-1 font-medium">Cola de Reproducción</span>
                    </div>
                    <div id="menu-history" class="menu-list-item menu-stagger-item">
                        <div class="bg-white/10 p-2 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
                        <span class="flex-1 font-medium">Historial Reciente</span>
                    </div>
                    <div id="menu-playlists" class="menu-list-item menu-stagger-item">
                        <div class="bg-white/10 p-2 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path></svg></div>
                        <span class="flex-1 font-medium">Mis Playlists</span>
                    </div>
                    <div id="menu-album-info" class="menu-list-item menu-stagger-item">
                        <div class="bg-white/10 p-2 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg></div>
                        <span class="flex-1 font-medium">Ver Álbum Actual</span>
                    </div>
                </div>
                <!-- Devices Tab -->
                <div id="menu-tab-devices" class="menu-tab-content hidden">
                    <p class="menu-section-title">Dispositivos Disponibles</p>
                    <div id="menu-device-list" class="flex flex-col gap-1">
                        <div class="text-center text-gray-400 py-4 animate-pulse">Buscando dispositivos...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lyrics Settings Modal -->
    <div id="lyrics-settings-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[55]">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Modo de Letra</h3>
                <button id="close-lyrics-settings-modal" class="p-2 hover:bg-white/10 rounded-full"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="flex flex-col gap-2" id="lyrics-mode-list">
                <div class="lyrics-mode-btn menu-list-item" data-mode="cover">
                    <div class="p-2 bg-indigo-500/20 text-indigo-300 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M9 3v18"></path></svg></div>
                    <div class="flex flex-col">
                        <span class="font-bold">Sobre Carátula</span>
                        <span class="text-xs text-gray-400">Minimalista y compacto</span>
                    </div>
                </div>
                <div class="lyrics-mode-btn menu-list-item" data-mode="side">
                    <div class="p-2 bg-pink-500/20 text-pink-300 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="3" x2="12" y2="21"></line></svg></div>
                    <div class="flex flex-col">
                        <span class="font-bold">Modo Dividido</span>
                        <span class="text-xs text-gray-400">Estilo Apple Music</span>
                    </div>
                </div>
                <div class="lyrics-mode-btn menu-list-item" data-mode="modal">
                    <div class="p-2 bg-teal-500/20 text-teal-300 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"></path><path d="M9 21H3v-6"></path><path d="M14 10l6.1-6.1"></path><path d="M10 14l-6.1 6.1"></path></svg></div>
                    <div class="flex flex-col">
                        <span class="font-bold">Pantalla Completa</span>
                        <span class="text-xs text-gray-400">Solo texto, foco total</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Settings Modal -->
    <div id="background-settings-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[55]">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Fondo y Canvas</h3>
                <button id="close-background-settings-modal" class="p-2 hover:bg-white/10 rounded-full"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <p class="menu-section-title">Modo de Video (Canvas)</p>
            <div id="canvas-mode-list-modal" class="flex flex-col gap-2 mb-6">
                 <div class="canvas-mode-btn menu-list-item" data-mode="none">
                    <div class="p-2 bg-gray-500/20 rounded-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
                    <span class="font-medium">Desactivado</span>
                </div>
                <div id="canvas-mode-options-modal" class="flex flex-col gap-2">
                    <div class="canvas-mode-btn menu-list-item" data-mode="background">
                        <div class="p-2 bg-green-500/20 rounded-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></div>
                        <span class="font-medium">Solo Fondo</span>
                    </div>
                    <div class="canvas-mode-btn menu-list-item" data-mode="cover">
                        <div class="p-2 bg-green-500/20 rounded-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="12" cy="12" r="3"></circle></svg></div>
                        <span class="font-medium">Reemplazar Carátula</span>
                    </div>
                    <div class="canvas-mode-btn menu-list-item" data-mode="both">
                         <div class="p-2 bg-green-500/20 rounded-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M12 3v18"></path></svg></div>
                        <span class="font-medium">Ambos</span>
                    </div>
                </div>
            </div>
            <div id="menu-blur-controls-modal" class="hidden">
                <p class="menu-section-title">Intensidad de Desenfoque</p>
                <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4" fill="currentColor" fill-opacity="0.5"></circle></svg>
                    <input type="range" id="menu-blur-slider-modal" min="0" max="100">
                    <span id="blur-value-display-modal" class="w-8 text-right font-mono text-sm">50</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Lyrics Modal -->
    <div id="lyrics-modal" class="hidden modal fixed inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-xl">
        <button id="close-lyrics-modal" class="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 rounded-full transition-colors z-10">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div id="lyrics-content" class="h-full w-full overflow-y-auto px-6 py-20 text-center custom-scrollbar mask-gradient max-w-4xl mx-auto"></div>
    </div>

    <!-- Generic Modals -->
    <div id="search-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-lg flex flex-col h-[60vh]">
            <h3 class="text-2xl font-bold mb-4">Buscar</h3>
            <input type="text" id="search-input" placeholder="¿Qué quieres escuchar?" class="w-full p-4 rounded-xl bg-white/10 mb-4 focus:outline-none focus:ring-2 focus:ring-[#1DB954] text-white placeholder-gray-400 transition-all">
            <div id="search-results" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col gap-2"></div>
            <button id="close-search-modal" class="mt-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-colors">Cerrar</button>
        </div>
    </div>
    <div id="queue-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-md flex flex-col h-[70vh]">
            <h3 class="text-2xl font-bold mb-4">Cola de Reproducción</h3>
            <ul id="queue-list" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col gap-2"></ul>
            <button id="close-queue-modal" class="mt-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-colors">Cerrar</button>
        </div>
    </div>
    <div id="history-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-md flex flex-col h-[70vh]">
            <h3 class="text-2xl font-bold mb-4">Escuchado Recientemente</h3>
            <ul id="history-list" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col gap-2"></ul>
            <button id="close-history-modal" class="mt-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-colors">Cerrar</button>
        </div>
    </div>
    <div id="playlists-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-md flex flex-col h-[70vh]">
            <h3 class="text-2xl font-bold mb-4">Mis Playlists</h3>
            <ul id="playlists-list" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col gap-2"></ul>
            <button id="close-playlists-modal" class="mt-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-colors">Cerrar</button>
        </div>
    </div>
    <div id="artist-info-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-8 w-full max-w-md flex flex-col items-center text-center max-h-[85vh] overflow-y-auto">
            <img id="artist-image" src="" class="w-40 h-40 rounded-full object-cover shadow-2xl mb-6 border-4 border-white/10">
            <h3 id="artist-name" class="text-3xl font-bold mb-2 text-shadow"></h3>
            <div id="artist-genres" class="flex flex-wrap justify-center gap-2 mb-4"></div>
            <div class="w-full border-t border-white/10 my-4"></div>
            <h4 class="text-sm uppercase tracking-widest text-gray-400 font-bold mb-4">Top Canciones</h4>
            <ol id="artist-top-tracks" class="w-full text-left space-y-2 list-decimal list-inside text-gray-200"></ol>
            <button id="close-artist-modal" class="mt-8 py-3 px-8 bg-white/10 hover:bg-white/20 rounded-full font-bold transition-colors">Cerrar</button>
        </div>
    </div>
    <div id="album-modal" class="hidden modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="modal-card glassmorphism rounded-3xl p-6 w-full max-w-md flex flex-col h-[70vh]">
            <div id="album-info-content" class="flex-1 overflow-y-auto custom-scrollbar"></div>
            <button id="close-album-modal" class="mt-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-colors">Cerrar</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-[#1DB954] text-black font-bold py-3 px-6 rounded-full shadow-2xl z-[100] flex items-center gap-3">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span id="toast-message">Notificación</span>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '83a5e3ff629c407e9de69f8e03ca5d26';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-read-playback-state user-modify-playback-state user-read-recently-played user-read-currently-playing playlist-read-private playlist-read-collaborative';
        const API_BASE_URL = 'https://api.spotify.com/v1';

        // --- DOM REFERENCES ---
        const ui = {
            body: document.getElementById('body'),
            appContainer: document.getElementById('app'),
            loginButton: document.getElementById('login-button'),
            playerView: document.getElementById('player'),
            albumCoverContainer: document.getElementById('album-cover-container'),
            albumCover: document.getElementById('album-cover'),
            songTitle: document.getElementById('song-title'),
            songArtist: document.getElementById('song-artist'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            timeCurrent: document.getElementById('time-current'),
            timeTotal: document.getElementById('time-total'),
            
            // Modals
            artistInfoModal: document.getElementById('artist-info-modal'),
            artistImage: document.getElementById('artist-image'),
            artistName: document.getElementById('artist-name'),
            artistGenres: document.getElementById('artist-genres'),
            artistTopTracks: document.getElementById('artist-top-tracks'),
            searchModal: document.getElementById('search-modal'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            queueModal: document.getElementById('queue-modal'),
            historyModal: document.getElementById('history-modal'),
            albumModal: document.getElementById('album-modal'),
            albumInfoContent: document.getElementById('album-info-content'),
            playlistsModal: document.getElementById('playlists-modal'),
            playlistsList: document.getElementById('playlists-list'),
            
            // Lyrics
            lyricsModal: document.getElementById('lyrics-modal'),
            lyricsContent: document.getElementById('lyrics-content'),
            closeLyricsModal: document.getElementById('close-lyrics-modal'),
            songLyricsButton: document.getElementById('song-lyrics-button'),
            lyricsCoverOverlay: document.getElementById('lyrics-cover-overlay'),
            lyricsCoverContent: document.getElementById('lyrics-cover-content'),
            lyricsSideContainer: document.getElementById('lyrics-side-container'),
            lyricsSideContent: document.getElementById('lyrics-side-content'),
            exitSideModeBtn: document.getElementById('exit-side-mode-btn'),
            sideSettingsBtn: document.getElementById('side-settings-btn'),
            sideTrackInfo: document.getElementById('side-track-info'),
            sideTrackTitle: document.getElementById('side-track-title'),
            sideTrackArtist: document.getElementById('side-track-artist'),
            lyricsSettingsModal: document.getElementById('lyrics-settings-modal'),
            closeLyricsSettingsModal: document.getElementById('close-lyrics-settings-modal'),
            lyricsModeList: document.getElementById('lyrics-mode-list'),

            // Menu & Settings
            canvasBgVideo: document.getElementById('canvas-bg-video'),
            canvasCoverVideo: document.getElementById('canvas-cover-video'),
            openMenuButton: document.getElementById('open-menu-button'),
            menuModal: document.getElementById('menu-modal'),
            closeMenuModal: document.getElementById('close-menu-modal-x'),
            menuVolumeSlider: document.getElementById('menu-volume-slider'),
            menuDeviceList: document.getElementById('menu-device-list'),
            menuAlbumInfo: document.getElementById('menu-album-info'),
            menuSearch: document.getElementById('menu-search'),
            menuBackgroundSettings: document.getElementById('menu-background-settings'),
            menuKiosk: document.getElementById('menu-kiosk'),
            menuLogout: document.getElementById('menu-logout'),
            menuQueue: document.getElementById('menu-queue'),
            menuHistory: document.getElementById('menu-history'),
            menuLyrics: document.getElementById('menu-lyrics'),
            menuPlaylists: document.getElementById('menu-playlists'),
            backgroundSettingsModal: document.getElementById('background-settings-modal'),
            closeBackgroundSettingsModal: document.getElementById('close-background-settings-modal'),
            canvasModeListModal: document.getElementById('canvas-mode-list-modal'),
            canvasModeOptionsModal: document.getElementById('canvas-mode-options-modal'),
            menuBlurControlsModal: document.getElementById('menu-blur-controls-modal'),
            menuBlurSliderModal: document.getElementById('menu-blur-slider-modal'),
            blurValueDisplayModal: document.getElementById('blur-value-display-modal'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
        };

        let state = {
            currentSongId: null,
            currentArtistId: null,
            currentAlbumId: null,
            currentSongName: null,
            currentArtistName: null,
            currentAlbumName: null,
            playbackCheckInterval: null,
            colorThief: new ColorThief(),
            animationFrameId: null,
            currentLyrics: null,
            currentLyricIndex: -1,
            lyricsMode: 'none',
            lyricsCache: new Map(),
            canvasBackgroundBlurLevel: 50,
            canvasMode: 'none',
            preferredCanvasMode: 'none',
            currentCanvasUrl: null,
            lastCanvasTrackId: null,
            currentDurationMs: 0
        };

        // --- AUTH ---
        function generateCodeVerifier() { const a=new Uint8Array(32); crypto.getRandomValues(a); return Array.from(a,b=>('0'+b.toString(16)).slice(-2)).join(''); }
        async function generateCodeChallenge(v) { const d=new TextEncoder().encode(v); const dg=await crypto.subtle.digest('SHA-256', d); return btoa(String.fromCharCode(...new Uint8Array(dg))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }

        async function redirectToSpotifyAuth() {
            const verifier = generateCodeVerifier();
            sessionStorage.setItem('code_verifier', verifier);
            const challenge = await generateCodeChallenge(verifier);
            const params = new URLSearchParams({
                response_type: 'code', client_id: CLIENT_ID, scope: SCOPES, redirect_uri: REDIRECT_URI,
                code_challenge_method: 'S256', code_challenge: challenge
            });
            window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function getAccessToken(code) {
            const verifier = sessionStorage.getItem('code_verifier');
            if (!verifier) { showLoginView(); return; }
            const params = new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code: code, redirect_uri: REDIRECT_URI, code_verifier: verifier });
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params });
                if (!response.ok) throw new Error('Auth failed');
                const data = await response.json();
                storeTokens(data);
                window.history.replaceState({}, document.title, window.location.pathname);
                showPlayerView();
            } catch (error) { clearSession(); showLoginView(); }
        }

        async function refreshAccessToken() {
            const refreshToken = sessionStorage.getItem('refresh_token');
            if (!refreshToken) return false;
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'refresh_token', refresh_token: refreshToken })
                });
                if (!response.ok) throw new Error('Refresh failed');
                storeTokens(await response.json());
                return true;
            } catch (error) { clearSession(); showLoginView(); return false; }
        }

        function storeTokens(data) {
            sessionStorage.setItem('access_token', data.access_token);
            if (data.refresh_token) sessionStorage.setItem('refresh_token', data.refresh_token);
            sessionStorage.setItem('token_expires_in', Date.now() + data.expires_in * 1000);
        }

        async function spotifyApiRequest(endpoint, options = {}) {
            if (!sessionStorage.getItem('access_token') || Date.now() > sessionStorage.getItem('token_expires_in')) {
                if (!await refreshAccessToken()) throw new Error('Auth failed');
            }
            const res = await fetch(endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`, {
                ...options, headers: { 'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`, ...options.headers }
            });
            if(res.status === 204) return null;
            return await res.json();
        }

        // --- LYRICS LOGIC (ROBUST) ---
        async function fetchLyrics(trackId, artist, title, album, durationMs) {
            // UI State Reset
            ui.lyricsContent.innerHTML = ui.lyricsCoverContent.innerHTML = ui.lyricsSideContent.innerHTML = '<p class="animate-pulse opacity-50 mt-10">Buscando letra...</p>';
            state.currentLyrics = null;
            state.currentLyricIndex = -1;
            
            // Check Cache
            if(state.lyricsCache.has(trackId)) { renderLyrics(state.lyricsCache.get(trackId)); return; }

            const durationSec = Math.round(durationMs / 1000);
            
            // Smart Search Query
            let queryTitle = title;
            let queryArtist = artist;
            let queryAlbum = album;

            try {
                // 1. Meta-Search to get cleaner metadata
                const searchRes = await fetch(`https://lyricsplus.prjktla.workers.dev/v1/songlist/search?q=${encodeURIComponent(`${title} ${artist}`)}`);
                if (searchRes.ok) {
                    const searchData = await searchRes.json();
                    if (searchData && searchData[0]) {
                        queryTitle = searchData[0].name;
                        queryArtist = searchData[0].artist;
                        queryAlbum = searchData[0].album;
                    }
                }
            } catch (e) { console.warn("Search metadata failed, using originals"); }

            const params = new URLSearchParams({ 
                title: queryTitle, 
                artist: queryArtist, 
                album: queryAlbum || '', 
                duration: durationSec, 
                source: 'spotify,apple,musixmatch' 
            });
            
            try {
                // 2. Fetch Lyrics
                let data;
                const r = await fetch(`https://lyricsplus.prjktla.workers.dev/v2/lyrics/get?${params}`);
                if (!r.ok) throw new Error('Primary API failed');
                data = await r.json();

                if(!data || !data.lyrics) throw new Error('No lyrics found');
                
                state.lyricsCache.set(trackId, data);
                renderLyrics(data);
            } catch (e) {
                // Fallback
                try {
                     const r2 = await fetch(`https://lyrics-plus-backend.vercel.app/v2/lyrics/get?${params}`);
                     if (!r2.ok) throw new Error('Fallback failed');
                     const data2 = await r2.json();
                     if (data2 && data2.lyrics) {
                         state.lyricsCache.set(trackId, data2);
                         renderLyrics(data2);
                         return;
                     }
                } catch(e2) {}
                
                const err = '<p class="opacity-50 mt-10">Letra no disponible</p>';
                ui.lyricsContent.innerHTML = ui.lyricsCoverContent.innerHTML = ui.lyricsSideContent.innerHTML = err;
            }
        }

        // Process RAW lyrics into word objects
        function processLyrics(lyrics) {
            if (!Array.isArray(lyrics)) return lyrics;
            return lyrics.map((line, i) => {
                const nextTime = lyrics[i+1]?.time || line.time + 5000;
                const duration = Math.min(nextTime - line.time, 10000);
                const words = line.text.split(' ');
                const charTotal = words.reduce((a,b)=>a+b.length,0) || 1;
                let t = line.time;
                return {
                    time: line.time,
                    words: words.map(w => {
                        const wd = (w.length/charTotal)*duration;
                        const d = { text: w, startTime: t, endTime: t+wd };
                        t+=wd;
                        return d;
                    })
                };
            });
        }

        function renderLyrics(data) {
             let html = '';
             if(Array.isArray(data.lyrics)) {
                 state.currentLyrics = processLyrics(data.lyrics);
                 html = state.currentLyrics.map((line, i) => `
                    <div class="lyric-line" data-time="${line.time}">
                        ${line.words.map((w, wi) => `<span class="lyric-word" data-start="${w.startTime}" data-end="${w.endTime}">${w.text}</span>`).join('')}
                    </div>
                 `).join('');
             } else {
                 // Plain text lyrics
                 html = `<div class="text-lg leading-relaxed whitespace-pre-wrap py-10">${data.lyrics.replace(/\[.*?\]/g,'').trim()}</div>`;
             }
             
             [ui.lyricsContent, ui.lyricsCoverContent, ui.lyricsSideContent].forEach(el => {
                 el.innerHTML = html;
                 el.scrollTo(0,0);
                 // Bind Clicks
                 el.querySelectorAll('.lyric-word').forEach(w => w.addEventListener('click', e => {
                     e.stopPropagation();
                     seek(parseInt(w.dataset.start));
                 }));
             });
             
             // Immediate sync attempt
             if (state.currentDurationMs > 0) syncLyrics(state.currentDurationMs * (parseFloat(ui.progressBar.style.transform.replace('scaleX(','').replace(')','')) || 0));
        }

        function syncLyrics(progress) {
            if(!state.currentLyrics || !Array.isArray(state.currentLyrics)) return;
            
            // Find Active Line
            let lineIdx = -1;
            // Optimize search by starting near current index
            let startSearch = Math.max(0, state.currentLyricIndex - 1);
            for(let i=startSearch; i < state.currentLyrics.length; i++) {
                if (progress >= state.currentLyrics[i].time && progress < (state.currentLyrics[i+1]?.time || Infinity)) {
                    lineIdx = i;
                    break;
                }
            }
            if(lineIdx === -1 && progress > state.currentLyrics[state.currentLyrics.length-1].time) lineIdx = state.currentLyrics.length-1;
            
            // Handle Line Change
            if(lineIdx !== state.currentLyricIndex) {
                state.currentLyricIndex = lineIdx;
                updateActiveLine(lineIdx);
            }

            // Handle Word Animation (Karaoke Effect)
            if(lineIdx !== -1) {
                const activeLine = state.currentLyrics[lineIdx];
                const activeContainer = state.lyricsMode === 'side' ? ui.lyricsSideContent : 
                                      (state.lyricsMode === 'cover' ? ui.lyricsCoverContent : ui.lyricsContent);
                
                // Only animate if container is visible
                if(activeContainer.offsetParent !== null) {
                    const lineEl = activeContainer.children[lineIdx];
                    if(lineEl) {
                        Array.from(lineEl.children).forEach((wordEl, i) => {
                             const wData = activeLine.words[i];
                             if(!wData) return;
                             if(progress >= wData.endTime) {
                                 wordEl.classList.add('played'); wordEl.classList.remove('active');
                                 wordEl.style.removeProperty('--word-progress');
                             } else if (progress >= wData.startTime) {
                                 wordEl.classList.add('active'); wordEl.classList.remove('played');
                                 const pct = Math.min(100, Math.max(0, ((progress - wData.startTime) / (wData.endTime - wData.startTime)) * 100));
                                 wordEl.style.setProperty('--word-progress', `${pct}%`);
                             } else {
                                 wordEl.classList.remove('active', 'played');
                                 wordEl.style.removeProperty('--word-progress');
                             }
                        });
                    }
                }
            }
        }

        function updateActiveLine(idx) {
             [ui.lyricsContent, ui.lyricsCoverContent, ui.lyricsSideContent].forEach(container => {
                 if(container.offsetParent === null) return; // Skip invisible
                 
                 const lines = container.children;
                 if (!lines || lines.length === 0) return;
                 
                 for(let i=0; i<lines.length; i++) {
                     const line = lines[i];
                     if(i < idx) { 
                         line.style.opacity = '0.4'; 
                         // Mark past lines as played
                         Array.from(line.children).forEach(w => w.classList.add('played'));
                     }
                     else if(i > idx) { 
                         line.style.opacity = state.lyricsMode === 'side' ? '0.5' : '1'; 
                         Array.from(line.children).forEach(w => w.classList.remove('played', 'active'));
                     }
                     else {
                         line.style.opacity = '1';
                         // Center scroll
                         const scrollTarget = line.offsetTop - (container.clientHeight/2) + (line.clientHeight/2);
                         container.scrollTo({ top: scrollTarget, behavior: 'smooth' });
                     }
                 }
             });
        }

        // --- CANVAS LOGIC ---
        async function fetchCanvas(trackId) {
            // Reset if track changed
            if(state.lastCanvasTrackId !== trackId) {
                state.currentCanvasUrl = null;
                state.lastCanvasTrackId = trackId;
                updateCanvasUI(); // Clear old video immediately
            }
            
            try {
                const res = await fetch(`https://spoticanvasapi-three.vercel.app/api/canvas?trackId=${trackId}`);
                const d = await res.json();
                if(d.canvasesList?.[0]?.canvasUrl) {
                    state.currentCanvasUrl = d.canvasesList[0].canvasUrl;
                    updateCanvasUI();
                }
            } catch(e) {}
        }

        function updateCanvasUI() {
            const mode = state.preferredCanvasMode;
            const hasCanvas = !!state.currentCanvasUrl;
            
            // 1. Background Video Handling
            if(hasCanvas && (mode === 'background' || mode === 'both')) {
                // Only set src if changed to avoid flicker
                if (ui.canvasBgVideo.src !== state.currentCanvasUrl) {
                    ui.canvasBgVideo.src = state.currentCanvasUrl;
                }
                ui.canvasBgVideo.play().catch(e => console.log("Bg play failed", e));
                ui.canvasBgVideo.style.opacity = 1;
                ui.body.classList.add('canvas-bg-active');
                ui.menuBlurControlsModal.classList.remove('hidden');
                ui.canvasBgVideo.style.filter = `blur(${state.canvasBackgroundBlurLevel}px) brightness(0.6)`;
            } else {
                ui.canvasBgVideo.style.opacity = 0;
                ui.body.classList.remove('canvas-bg-active');
                // Pause after fade out
                setTimeout(() => { if(ui.canvasBgVideo.style.opacity == 0) ui.canvasBgVideo.pause(); }, 1500);
            }

            // 2. Cover Video Handling
            if(hasCanvas && (mode === 'cover' || mode === 'both')) {
                if (ui.canvasCoverVideo.src !== state.currentCanvasUrl) {
                    ui.canvasCoverVideo.src = state.currentCanvasUrl;
                }
                ui.canvasCoverVideo.classList.remove('hidden');
                ui.albumCover.classList.add('hidden');
                ui.canvasCoverVideo.play().catch(e => console.log("Cover play failed", e));
            } else {
                ui.canvasCoverVideo.classList.add('hidden');
                ui.albumCover.classList.remove('hidden');
                ui.canvasCoverVideo.pause();
            }
            
            // Show/Hide Canvas Options in Menu
            if (state.preferredCanvasMode !== 'none') {
                ui.canvasModeOptionsModal.classList.remove('hidden');
            } else {
                ui.canvasModeOptionsModal.classList.add('hidden');
            }
        }

        // --- MAIN UPDATE LOOP ---
        async function update() {
            try {
                const data = await spotifyApiRequest('/me/player/currently-playing?market=ES');
                
                // Handle no playback
                if(!data || !data.item) {
                     ui.songTitle.textContent = "Nada reproduciéndose";
                     ui.songArtist.textContent = "Abre Spotify";
                     return;
                }

                const item = data.item;
                const progress = data.progress_ms;

                // Track Change Detection
                if(item.id !== state.currentSongId) {
                    state.currentSongId = item.id;
                    state.currentDurationMs = item.duration_ms;
                    
                    // Basic UI Update
                    ui.songTitle.textContent = item.name;
                    ui.songArtist.innerHTML = item.artists.map(a=>`<span onclick="openArtist('${a.id}')">${a.name}</span>`).join(', ');
                    ui.albumCover.src = item.album.images[0].url;
                    
                    // Side Mode Info
                    ui.sideTrackTitle.textContent = item.name;
                    ui.sideTrackArtist.textContent = item.artists.map(a=>a.name).join(', ');
                    
                    ui.timeTotal.textContent = fmtTime(item.duration_ms);

                    // Color Extraction & Theme
                    ui.albumCover.onload = () => {
                         const color = state.colorThief.getColor(ui.albumCover);
                         const rgb = `rgb(${color.join(',')})`;
                         document.documentElement.style.setProperty('--primary', rgb);
                         ui.progressBar.style.backgroundColor = rgb;
                         ui.progressBar.style.boxShadow = `0 0 20px ${rgb}`;
                         // Set body background
                         if (!ui.body.classList.contains('canvas-bg-active')) {
                            ui.body.style.backgroundImage = `url(${ui.albumCover.src})`;
                         }
                    };

                    // Fetch External Data
                    fetchCanvas(item.id);
                    fetchLyrics(item.id, item.artists[0].name, item.name, item.album.name, item.duration_ms);
                }
                
                // Animation Frame Logic
                if(data.is_playing) {
                     if(!state.animationFrameId) {
                         let start = Date.now();
                         const loop = () => {
                             const p = progress + (Date.now() - start);
                             updateProgress(p, item.duration_ms);
                             syncLyrics(p);
                             if(p < item.duration_ms) state.animationFrameId = requestAnimationFrame(loop);
                             else update(); // Refresh on end
                         };
                         loop();
                     }
                } else {
                    cancelAnimationFrame(state.animationFrameId);
                    state.animationFrameId = null;
                    updateProgress(progress, item.duration_ms);
                    syncLyrics(progress);
                }

            } catch(e) { console.error("Update Error:", e); }
        }

        function updateProgress(curr, total) {
             const pct = (curr/total)*100;
             ui.progressBar.style.transform = `scaleX(${pct/100})`;
             ui.timeCurrent.textContent = fmtTime(curr);
        }

        function fmtTime(ms) { const s=Math.floor(ms/1000); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        async function seek(ms) { await spotifyApiRequest(`/me/player/seek?position_ms=${ms}`, {method:'PUT'}); setTimeout(update, 500); }
        async function setVol(v) { await spotifyApiRequest(`/me/player/volume?volume_percent=${v}`, {method:'PUT'}); }
        
        // --- MODAL FUNCTIONS ---
        const openModal = (m) => m.classList.remove('hidden');
        const closeModal = (m) => m.classList.add('hidden');
        
        async function openArtist(id) {
            openModal(ui.artistInfoModal);
            const d = await spotifyApiRequest(`/artists/${id}`);
            const t = await spotifyApiRequest(`/artists/${id}/top-tracks?market=ES`);
            ui.artistName.textContent = d.name;
            ui.artistImage.src = d.images[0]?.url;
            ui.artistGenres.innerHTML = d.genres.slice(0,3).map(g=>`<span class="px-2 py-1 bg-white/10 rounded-full text-xs uppercase">${g}</span>`).join('');
            ui.artistTopTracks.innerHTML = t.tracks.slice(0,5).map(tr=>`<li class="p-2 hover:bg-white/10 rounded cursor-pointer transition-colors" onclick="playUri('${tr.uri}')">${tr.name}</li>`).join('');
        }

        async function fetchQueue() {
            openModal(ui.queueModal);
            const d = await spotifyApiRequest('/me/player/queue');
            if (d && d.queue) {
                document.getElementById('queue-list').innerHTML = d.queue.map(t=>`
                    <li class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-all" onclick="playUri('${t.uri}')">
                        <img src="${t.album.images[2]?.url || 'https://placehold.co/40'}" class="w-10 h-10 rounded">
                        <div class="overflow-hidden">
                            <div class="font-bold truncate">${t.name}</div>
                            <div class="text-xs text-gray-400 truncate">${t.artists[0].name}</div>
                        </div>
                    </li>
                `).join('');
            }
        }

        async function search(q) {
            if(!q) return;
            const d = await spotifyApiRequest(`/search?q=${q}&type=track&limit=10`);
            ui.searchResults.innerHTML = d.tracks.items.map(t=>`
                <div class="flex items-center gap-3 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-all" onclick="playUri('${t.uri}')">
                    <img src="${t.album.images[2]?.url}" class="w-12 h-12 rounded shadow">
                    <div>
                        <div class="font-bold text-sm">${t.name}</div>
                        <div class="text-xs text-gray-400">${t.artists[0].name}</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function playUri(uri) { await spotifyApiRequest('/me/player/play', {method:'PUT', body:JSON.stringify({uris:[uri]})}); setTimeout(update, 1000); closeModal(ui.searchModal); }

        function setLyricsMode(mode) {
             state.lyricsMode = mode;
             localStorage.setItem('lyricMode', mode);
             
             // Reset UI State
             ui.appContainer.classList.remove('lyrics-mode-side');
             ui.lyricsCoverOverlay.classList.remove('opacity-100', 'pointer-events-auto');
             ui.lyricsCoverOverlay.classList.add('opacity-0', 'pointer-events-none');
             ui.lyricsModal.classList.add('hidden');
             ui.sideSettingsBtn.classList.add('hidden');
             ui.exitSideModeBtn.classList.add('hidden');
             ui.sideTrackInfo.classList.add('hidden');
             ui.songLyricsButton.classList.remove('hidden');
             ui.lyricsSideContainer.classList.add('hidden'); // Hide by default

             // Apply Specific Mode Logic
             if(mode === 'side') {
                 ui.appContainer.classList.add('lyrics-mode-side');
                 ui.sideSettingsBtn.classList.remove('hidden');
                 ui.exitSideModeBtn.classList.remove('hidden');
                 ui.sideTrackInfo.classList.remove('hidden');
                 ui.songLyricsButton.classList.add('hidden'); // Hide lyric button in side mode
                 ui.lyricsSideContainer.classList.remove('hidden'); // Show container
             } else if (mode === 'cover') {
                 ui.lyricsCoverOverlay.classList.remove('opacity-0', 'pointer-events-none');
                 ui.lyricsCoverOverlay.classList.add('opacity-100', 'pointer-events-auto');
             } else if (mode === 'modal') {
                 ui.lyricsModal.classList.remove('hidden');
             }
             
             // Update Checkmarks in Menu
             ui.lyricsModeList.querySelectorAll('.lyrics-mode-btn').forEach(btn => {
                 btn.classList.toggle('active', btn.dataset.mode === mode);
             });
             closeModal(ui.lyricsSettingsModal);
             
             // Trigger sync to refresh view
             if (state.currentDurationMs) syncLyrics(state.currentDurationMs * (parseFloat(ui.progressBar.style.transform.replace('scaleX(','').replace(')','')) || 0));
        }

        // --- INIT ---
        function init() {
            // Event Listeners
            ui.loginButton.onclick = redirectToSpotifyAuth;
            ui.openMenuButton.onclick = () => openModal(ui.menuModal);
            document.getElementById('close-menu-modal-x').onclick = () => closeModal(ui.menuModal);
            
            // Tab Switching Logic
            document.querySelectorAll('.menu-tab-button').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.menu-tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.menu-tab-content').forEach(c => c.classList.add('hidden'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.remove('hidden');
                    // Reset animations
                    document.getElementById(btn.dataset.tab).querySelectorAll('.menu-stagger-item').forEach(el => {
                        el.style.animation = 'none';
                        el.offsetHeight; 
                        el.style.animation = null; 
                    });
                    if(btn.dataset.tab === 'menu-tab-devices') loadDevices();
                }
            });

            // Settings Listeners
            ui.menuVolumeSlider.oninput = (e) => setVol(e.target.value);
            ui.searchInput.oninput = (e) => { clearTimeout(state.st); state.st = setTimeout(() => search(e.target.value), 300); };
            
            // Menu Items Actions
            document.getElementById('menu-lyrics').onclick = () => { closeModal(ui.menuModal); openModal(ui.lyricsSettingsModal); };
            document.getElementById('menu-background-settings').onclick = () => { closeModal(ui.menuModal); openModal(ui.backgroundSettingsModal); };
            document.getElementById('menu-search').onclick = () => { closeModal(ui.menuModal); openModal(ui.searchModal); ui.searchInput.focus(); };
            document.getElementById('menu-queue').onclick = () => { closeModal(ui.menuModal); fetchQueue(); };
            document.getElementById('menu-history').onclick = () => { closeModal(ui.menuModal); openModal(ui.historyModal); fetchHistory(); }; 
            document.getElementById('menu-logout').onclick = () => { sessionStorage.clear(); location.reload(); };
            document.getElementById('menu-kiosk').onclick = () => { document.documentElement.requestFullscreen(); };
            
            // Lyrics Mode Switching
            ui.lyricsModeList.onclick = (e) => {
                const btn = e.target.closest('.lyrics-mode-btn');
                if(btn) setLyricsMode(btn.dataset.mode);
            };
            ui.songLyricsButton.onclick = () => openModal(ui.lyricsSettingsModal);
            ui.exitSideModeBtn.onclick = () => setLyricsMode('none');
            
            // Canvas Mode Switching
            ui.canvasModeListModal.onclick = (e) => {
                const btn = e.target.closest('.canvas-mode-btn');
                if(!btn) return;
                state.preferredCanvasMode = btn.dataset.mode;
                localStorage.setItem('canvasMode', state.preferredCanvasMode);
                updateCanvasUI();
                // Update UI checkmarks
                ui.canvasModeListModal.querySelectorAll('.canvas-mode-btn').forEach(b => b.classList.remove('active'));
                ui.canvasModeOptionsModal.querySelectorAll('.canvas-mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            ui.menuBlurSliderModal.oninput = (e) => {
                 state.canvasBackgroundBlurLevel = e.target.value;
                 ui.blurValueDisplayModal.textContent = e.target.value;
                 updateCanvasUI();
            };

            // Modal Closes
            [ui.searchModal, ui.queueModal, ui.historyModal, ui.artistInfoModal, ui.albumModal, ui.playlistsModal, ui.lyricsSettingsModal, ui.backgroundSettingsModal]
            .forEach(m => {
                const closeBtn = m.querySelector('button[id^="close-"]');
                if(closeBtn) closeBtn.onclick = () => closeModal(m);
            });
            ui.closeLyricsModal.onclick = () => closeModal(ui.lyricsModal);

            // Progress Bar Seek
            ui.progressContainer.onclick = (e) => {
                if(!state.currentDurationMs) return;
                const rect = ui.progressContainer.getBoundingClientRect();
                const pct = (e.clientX - rect.left) / rect.width;
                seek(state.currentDurationMs * pct);
            };

            // Init Load
            const code = new URLSearchParams(location.search).get('code');
            if(code) getAccessToken(code);
            else if(sessionStorage.getItem('access_token')) showPlayerView();
            else showLoginView();
            
            // Restore Settings
            const savedLyricMode = localStorage.getItem('lyricMode');
            if(savedLyricMode) setLyricsMode(savedLyricMode);
            
            state.preferredCanvasMode = localStorage.getItem('canvasMode') || 'none';
            // Set active class on canvas mode
            const activeCanvasBtn = ui.canvasModeListModal.querySelector(`[data-mode="${state.preferredCanvasMode}"]`);
            if (activeCanvasBtn) activeCanvasBtn.classList.add('active');
            
            state.canvasBackgroundBlurLevel = 50;
        }

        function showPlayerView() {
            document.getElementById('login').classList.add('hidden');
            ui.playerView.classList.remove('hidden');
            setInterval(update, 1000);
            update();
        }
        function showLoginView() { document.getElementById('login').classList.remove('hidden'); }
        function clearSession() { sessionStorage.clear(); }
        async function fetchHistory() { const d = await spotifyApiRequest('/me/player/recently-played'); document.getElementById('history-list').innerHTML = d.items.map(i=>`<li class="p-3 hover:bg-white/10 rounded cursor-pointer" onclick="playUri('${i.track.uri}')">${i.track.name}</li>`).join(''); }
        async function loadDevices() {
             const d = await spotifyApiRequest('/me/player/devices');
             ui.menuDeviceList.innerHTML = d.devices.map(dev => `
                <div class="menu-list-item menu-stagger-item ${dev.is_active ? 'active' : ''}" onclick="transfer('${dev.id}')">
                    <div class="p-2 bg-white/10 rounded-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12" y2="18"></line></svg></div>
                    <span class="font-medium">${dev.name}</span>
                </div>
             `).join('');
        }
        async function transfer(id) { await spotifyApiRequest('/me/player', {method:'PUT', body:JSON.stringify({device_ids:[id]})}); closeModal(ui.menuModal); }

        window.onload = init;
    </script>
</body>
</html>
