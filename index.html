<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            background-image: linear-gradient(135deg, #0f172a, #101010);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
            position: relative;
            transition: none;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: inherit;
            background-size: inherit;
            background-position: inherit;
            z-index: -1;
            filter: blur(50px) brightness(0.6);
            transform: scale(1.2);
            transition: filter 0.5s ease, background-image 0.5s ease;
        }

        body.canvas-bg-active::before {
            background-image: none !important;
            filter: none !important;
        }

        #canvas-bg-video {
            opacity: 0;
            transition: opacity 0.5s ease, filter 0.5s ease;
            filter: blur(50px) brightness(0.6);
            transform: scale(1.2);
            pointer-events: none;
        }

        #canvas-cover-video { object-fit: cover; }

        .progress-bar {
            transition: transform 0.5s linear, background-color 0.5s ease, box-shadow 0.5s ease;
            transform-origin: left;
            will-change: transform;
            background-color: #1DB954;
            box-shadow: 0 0 10px #1DB954;
        }

        .glassmorphism {
            background: rgba(25, 25, 35, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        #player { box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- LYRICS LAYOUTS --- */
        
        /* Layout: Right (Desktop) */
        #app.layout-lyrics-right #player {
            max-width: 95vw !important;
            width: auto;
            flex-direction: row;
            align-items: stretch;
            gap: 2rem;
        }
        #app.layout-lyrics-right #player-main-content {
            flex: 0 0 auto;
            width: 100%;
            max-width: 450px; /* Ancho fijo para la parte del player */
        }
        #app.layout-lyrics-right #lyrics-side-panel {
            display: flex !important;
            flex: 1 1 auto;
            min-width: 300px;
            border-left: 1px solid rgba(255,255,255,0.1);
            padding-left: 2rem;
            flex-direction: column;
        }
        
        /* Mobile override for Right layout */
        @media (max-width: 1024px) {
            #app.layout-lyrics-right #player {
                flex-direction: column;
                max-width: 100%;
            }
            #app.layout-lyrics-right #player-main-content { max-width: 100%; }
            #app.layout-lyrics-right #lyrics-side-panel {
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                padding-left: 0;
                padding-top: 2rem;
                height: 400px; /* Altura fija en móvil */
            }
        }

        .fade-in-up { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Styles for Settings & Lists --- */
        .modal-card, .popover-card { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal.hidden .modal-card { transform: scale(0.95) translateY(10px); opacity: 0; }

        .settings-btn {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .settings-btn.active { background: rgba(255, 255, 255, 0.15); color: #1DB954; font-weight: bold; border: 1px solid rgba(30, 215, 96, 0.3); }

        /* --- LYRICS TYPOGRAPHY & SCROLL --- */
        .lyrics-scroll-area {
            mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-top: 40%; 
            padding-bottom: 40%;
            scrollbar-width: none;
        }
        .lyrics-scroll-area::-webkit-scrollbar { display: none; }

        .lyric-line {
            font-size: 1.25rem; 
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            font-weight: 600;
            transform-origin: left center;
        }
        
        #app.layout-lyrics-right .lyric-line { font-size: 1.5rem; } /* Más grande en layout derecha */

        .lyric-line:hover { color: rgba(255, 255, 255, 0.8); background: rgba(255,255,255,0.05); }
        .lyric-line.active {
            color: #ffffff;
            opacity: 1;
            transform: scale(1.02) translateX(10px);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        /* Helpers */
        .hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    </style>
</head>
<body id="body" class="p-4">

    <video id="canvas-bg-video" class="fixed inset-0 w-full h-full object-cover -z-[2]" autoplay loop muted playsinline></video>
    <div id="transition-overlay" class="fixed inset-0" style="background: linear-gradient(135deg, #0f172a, #101010); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.4s ease-in-out;"></div>

    <div class="flex justify-center items-center w-full min-h-screen">
        <div id="app" class="w-full max-w-sm sm:max-w-md md:max-w-4xl transition-all duration-500">

            <div id="login" class="flex flex-col items-center fade-in-up">
                <h1 class="text-4xl md:text-5xl font-black mb-2 tracking-tighter">Now Playing</h1>
                <p class="text-lg text-gray-300 mb-8">Conecta tu cuenta para empezar</p>
                <button id="login-button" class="glassmorphism flex items-center justify-center text-white font-bold px-8 py-3 rounded-full transition-all duration-300 hover:scale-105">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 167.5 167.5" fill="currentColor"><path d="M83.7 0C37.5 0 0 37.5 0 83.7c0 46.3 37.5 83.7 83.7 83.7 46.3 0 83.7-37.5 83.7-83.7S130 0 83.7 0zM122 120.8c-1.4 2.5-4.4 3.2-6.8 1.8-19.7-12-44.5-14.7-73.7-8.1-2.8.6-5.6-1.2-6.2-4-.6-2.8 1.2-5.6 4-6.2 32-7.3 59.6-4.2 81.6 9.3 2.6 1.5 3.4 4.7 1.9 7.2zM133.5 98.1c-1.7 3-5.2 4-8.2 2.3-22.5-13.8-56.8-17.8-83.4-9.8-3.2 1-6.5-1-7.5-4.3-1-3.2 1-6.5 4.3-7.5 30.4-9 68.2-4.5 94.5 11.2 3.1 1.9 4.2 5.7 2.3 8.8zm1.1-24.3c-2-3.5-6.2-4.6-9.7-2.6-26.4-15.8-70.3-17.2-97.4-9.4-3.9 1.1-8-1.2-9.1-5.2-1.1-3.9 1.2-8 5.2-9.1 31-8.7 79.4-7.1 109.8 10.5 3.6 2.1 4.8 6.8 2.7 10.4z"></path></svg>
                    Conectar con Spotify
                </button>
            </div>

            <!-- PLAYER CONTAINER -->
            <div id="player" class="hidden glassmorphism p-6 md:p-8 rounded-3xl fade-in-up">
                
                <!-- Main Content (Cover + Controls) -->
                <div id="player-main-content" class="flex flex-col md:flex-row md:items-center md:gap-8">
                    
                    <div id="album-cover-container" class="album-cover-container relative mb-6 md:mb-0 flex-shrink-0">
                        <img id="album-cover" class="absolute inset-0 w-full h-full rounded-2xl shadow-2xl object-cover" src="" crossorigin="anonymous">
                        <video id="canvas-cover-video" class="hidden absolute inset-0 w-full h-full rounded-2xl shadow-2xl object-cover" autoplay loop muted playsinline></video>
                    </div>

                    <div class="flex flex-col w-full text-center md:text-left justify-center">
                        <div id="song-title-container" class="flex items-center justify-center md:justify-between gap-3 mb-1">
                            <h2 id="song-title" class="text-2xl md:text-3xl font-bold tracking-tight text-shadow truncate">Cargando...</h2>
                            
                            <!-- Botones de Letra -->
                            <div class="flex gap-2">
                                <button id="lyrics-settings-btn" title="Configurar Letra" class="control-button p-2 rounded-full hover:bg-white/10 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                                <button id="song-lyrics-button" title="Abrir Tarjeta de Letra" class="control-button p-2 rounded-full hover:bg-white/10 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                                </button>
                            </div>
                        </div>
                        <p id="song-artist" class="text-lg text-gray-300 mb-5 font-medium">Cargando...</p>

                        <div id="progress-container" class="w-full bg-white/10 rounded-full h-1.5 mb-2 overflow-hidden cursor-pointer hover:h-2 transition-all">
                            <div id="progress-bar" class="progress-bar h-full w-full"></div>
                        </div>
                        <div class="w-full flex justify-between text-xs font-medium text-gray-400 mb-6">
                            <span id="time-current">0:00</span>
                            <span id="time-total">0:00</span>
                        </div>

                        <div class="relative flex items-center justify-center md:justify-start gap-4">
                            <button id="open-menu-button" title="Menú" class="control-button p-3 rounded-full hover:bg-white/10 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>
                            </button>
                        </div>

                        <!-- INLINE LYRICS CONTAINER (Modo "Debajo") -->
                        <div id="lyrics-inline-container" class="hidden w-full mt-6 border-t border-white/10 pt-4 transition-all duration-500">
                            <div id="lyrics-inline-content" class="h-64 overflow-y-auto lyrics-scroll-area text-center relative px-4">
                                <p class="text-gray-500 text-sm mt-10">Esperando letra...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SIDE LYRICS PANEL (Modo "Derecha") -->
                <div id="lyrics-side-panel" class="hidden h-full overflow-hidden relative">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Letra</h3>
                    <div id="lyrics-side-content" class="h-full overflow-y-auto lyrics-scroll-area text-left pr-2">
                        <p class="text-gray-500 mt-10">Cargando...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals (Search, Artist, Etc...) -->
    <!-- [Existing modals code omitted for brevity, keeping structure] -->
    <div id="search-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-lg flex flex-col"><h3 class="text-2xl font-bold mb-4">Buscar</h3><input type="text" id="search-input" placeholder="Buscar..." class="w-full p-3 rounded-lg bg-white/20 mb-4 focus:outline-none"><div id="search-results" class="max-h-80 overflow-y-auto mb-4 pr-2 custom-scrollbar"></div><button id="close-search-modal" class="mt-auto bg-white/10 hover:bg-white/20 py-2 px-6 rounded-full self-center">Cerrar</button></div></div>
    <div id="artist-info-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div id="artist-info-card" class="modal-card glassmorphism rounded-2xl p-8 w-full max-w-md flex flex-col items-center"><img id="artist-image" src="" class="w-40 h-40 rounded-full mb-4"><h3 id="artist-name" class="text-2xl font-bold"></h3><div id="artist-genres" class="flex flex-wrap justify-center gap-2 mb-4"></div><p class="text-gray-300 mb-4"><strong id="artist-followers"></strong> followers</p><ol id="artist-top-tracks" class="list-decimal list-inside w-full mb-6"></ol><button id="close-artist-modal" class="bg-white/10 hover:bg-white/20 py-2 px-6 rounded-full">Cerrar</button></div></div>
    <div id="queue-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col"><h3 class="text-2xl font-bold mb-4">Cola</h3><ul id="queue-list" class="max-h-80 overflow-y-auto mb-4 custom-scrollbar"></ul><button id="close-queue-modal" class="mt-auto bg-white/10 hover:bg-white/20 py-2 px-6 rounded-full self-center">Cerrar</button></div></div>
    <div id="history-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col"><h3 class="text-2xl font-bold mb-4">Historial</h3><ul id="history-list" class="max-h-80 overflow-y-auto mb-4 custom-scrollbar"></ul><button id="close-history-modal" class="mt-auto bg-white/10 hover:bg-white/20 py-2 px-6 rounded-full self-center">Cerrar</button></div></div>
    <div id="album-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col"><div id="album-info-content"></div><button id="close-album-modal" class="mt-auto bg-white/10 hover:bg-white/20 py-2 px-6 rounded-full self-center">Cerrar</button></div></div>
    <div id="playlists-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col"><h3 class="text-2xl font-bold mb-4">Playlists</h3><ul id="playlists-list" class="max-h-80 overflow-y-auto mb-4 custom-scrollbar"></ul><button id="close-playlists-modal" class="mt-auto bg-white/10 hover:bg-white/20 py-2 px-6 rounded-full self-center">Cerrar</button></div></div>
    <div id="menu-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col relative"><button id="close-menu-modal-x" class="absolute top-4 right-4 text-gray-400 hover:text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button><h3 class="text-2xl font-bold mb-4 text-center">Menú</h3><div class="flex border-b border-white/10 mb-4"><button class="menu-tab-button active flex-1 py-2" data-tab="menu-tab-actions">Acciones</button><button class="menu-tab-button flex-1 py-2" data-tab="menu-tab-lists">Listas</button><button class="menu-tab-button flex-1 py-2" data-tab="menu-tab-devices">Dispositivos</button></div><div class="max-h-80 overflow-y-auto pr-2 custom-scrollbar"><div id="menu-tab-actions" class="menu-tab-content"><div id="actions-list" class="flex flex-col gap-4"><div><p class="text-xs text-gray-400 uppercase font-bold mb-2 px-3">Media</p><ul class="flex flex-col gap-1"><li id="menu-album-info" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Ver Álbum</li></ul></div><div><p class="text-xs text-gray-400 uppercase font-bold mb-2 px-3">App</p><ul class="flex flex-col gap-1"><li id="menu-search" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Buscar</li><li id="menu-background-settings" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Personalización</li><li id="menu-kiosk" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Modo Kiosco</li></ul></div><div><p class="text-xs text-gray-400 uppercase font-bold mb-2 px-3">Audio</p><ul><li class="p-3 rounded-lg flex items-center gap-3">Volumen<input type="range" id="menu-volume-slider" min="0" max="100" class="w-full ml-auto"></li></ul></div><div><ul class="flex flex-col gap-1"><li id="menu-logout" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10 text-red-400">Cerrar Sesión</li></ul></div></div></div><div id="menu-tab-lists" class="menu-tab-content hidden"><ul class="flex flex-col gap-2"><li id="menu-queue" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Cola</li><li id="menu-history" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Historial</li><li id="menu-playlists" class="p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-white/10">Playlists</li></ul></div><div id="menu-tab-devices" class="menu-tab-content hidden"><ul id="menu-device-list" class="text-sm"><li>Cargando...</li></ul></div></div></div></div>

    <!-- MODAL DE LETRAS (TARJETA FLOTANTE) -->
    <div id="lyrics-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 backdrop-blur-md">
        <div class="modal-card w-full max-w-2xl h-[85vh] relative rounded-3xl overflow-hidden shadow-2xl border border-white/10 bg-black/60">
            <button id="close-lyrics-modal" class="absolute top-4 right-4 z-20 bg-black/40 hover:bg-white/20 p-2 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div id="lyrics-content" class="lyrics-scroll-area h-full w-full px-8 text-center pt-20 pb-20">
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <!-- CONFIGURACIÓN MODAL (Renovado) -->
    <div id="background-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[51]">
        <div class="modal-card glassmorphism rounded-2xl p-6 w-full max-w-md flex flex-col relative">
            <button id="close-background-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-center">Personalización</h3>

            <div class="max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar flex flex-col gap-6">
                
                <!-- Sección Letras -->
                <div class="settings-section">
                    <p class="settings-title px-3">Visualización de Letra</p>
                    <ul class="flex flex-col gap-1" id="lyrics-position-list">
                        <li class="settings-btn" data-pos="off">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            Oculto
                        </li>
                        <li class="settings-btn" data-pos="inline">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 12h8"/><path d="M8 16h8"/></svg>
                            Debajo del Player
                        </li>
                        <li class="settings-btn" data-pos="right">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/><path d="M14 8h5"/><path d="M14 12h5"/><path d="M14 16h5"/></svg>
                            Derecha (Escritorio)
                        </li>
                        <li class="settings-btn" data-pos="card">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 8h8"/><path d="M8 12h8"/><path d="M8 16h8"/></svg>
                            Tarjeta Flotante
                        </li>
                    </ul>
                </div>

                <div class="border-t border-white/10 my-1"></div>

                <!-- Canvas Options -->
                <div class="settings-section">
                    <p class="settings-title px-3">Fondo Canvas</p>
                    <ul id="canvas-mode-list-modal" class="flex flex-col gap-1">
                        <li class="canvas-mode-btn settings-btn" data-mode="none">Desactivado</li>
                        <div id="canvas-mode-options-modal" class="hidden flex flex-col gap-1">
                            <li class="canvas-mode-btn settings-btn" data-mode="background">Fondo Animado</li>
                            <li class="canvas-mode-btn settings-btn" data-mode="cover">Carátula Animada</li>
                            <li class="canvas-mode-btn settings-btn" data-mode="both">Ambos</li>
                            <li class="canvas-mode-btn settings-btn" data-mode="portrait">Retrato (9:16)</li>
                        </div>
                    </ul>
                </div>

                <div id="portrait-position-controls-modal" class="settings-section hidden pl-4 pr-2">
                    <p class="settings-title px-3">Posición Retrato</p>
                    <ul id="portrait-position-list-modal" class="flex flex-col gap-1">
                        <li class="portrait-position-btn settings-btn" data-position="left">Izquierda</li>
                        <li class="portrait-position-btn settings-btn" data-position="center">Centro</li>
                    </ul>
                </div>

                <div id="menu-blur-controls-modal" class="settings-section hidden p-3 flex items-center gap-3">
                    <label class="text-sm">Desenfoque</label>
                    <input type="range" id="menu-blur-slider-modal" min="0" max="100" class="w-full">
                    <span id="blur-value-display-modal" class="text-xs text-gray-400 w-6">50</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '83a5e3ff629c407e9de69f8e03ca5d26';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-read-playback-state user-modify-playback-state user-read-recently-played user-read-currently-playing playlist-read-private playlist-read-collaborative';
        const API_BASE_URL = 'https://api.spotify.com/v1';

        // --- DOM REFERENCES ---
        const ui = {
            body: document.getElementById('body'),
            appContainer: document.getElementById('app'),
            loginButton: document.getElementById('login-button'),
            playerView: document.getElementById('player'),
            albumCoverContainer: document.getElementById('album-cover-container'),
            albumCover: document.getElementById('album-cover'),
            songTitle: document.getElementById('song-title'),
            songArtist: document.getElementById('song-artist'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            timeCurrent: document.getElementById('time-current'),
            timeTotal: document.getElementById('time-total'),
            // Modals
            artistInfoModal: document.getElementById('artist-info-modal'),
            searchModal: document.getElementById('search-modal'),
            queueModal: document.getElementById('queue-modal'),
            historyModal: document.getElementById('history-modal'),
            albumModal: document.getElementById('album-modal'),
            playlistsModal: document.getElementById('playlists-modal'),
            settingsModal: document.getElementById('background-settings-modal'),
            menuModal: document.getElementById('menu-modal'),
            lyricsModal: document.getElementById('lyrics-modal'),
            // Buttons
            openMenuButton: document.getElementById('open-menu-button'),
            songLyricsButton: document.getElementById('song-lyrics-button'), // Boton tarjeta
            lyricsSettingsBtn: document.getElementById('lyrics-settings-btn'), // Nuevo boton ajustes
            // Lyric Containers
            lyricsInlineContainer: document.getElementById('lyrics-inline-container'),
            lyricsInlineContent: document.getElementById('lyrics-inline-content'),
            lyricsSidePanel: document.getElementById('lyrics-side-panel'),
            lyricsSideContent: document.getElementById('lyrics-side-content'),
            lyricsModalContent: document.getElementById('lyrics-content'),
            // Canvas Elements
            canvasBgVideo: document.getElementById('canvas-bg-video'),
            canvasCoverVideo: document.getElementById('canvas-cover-video'),
            // Inputs
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            menuVolumeSlider: document.getElementById('menu-volume-slider'),
            // Toast
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            // Settings UI
            lyricsPositionList: document.getElementById('lyrics-position-list'),
            canvasModeList: document.getElementById('canvas-mode-list-modal'),
            canvasOptions: document.getElementById('canvas-mode-options-modal'),
            portraitControls: document.getElementById('portrait-position-controls-modal'),
            blurControls: document.getElementById('menu-blur-controls-modal'),
            blurSlider: document.getElementById('menu-blur-slider-modal'),
            blurDisplay: document.getElementById('blur-value-display-modal'),
        };

        // --- APP STATE ---
        let state = {
            currentSongId: null,
            currentArtistId: null,
            currentAlbumId: null,
            currentSongName: null,
            currentArtistName: null,
            currentAlbumName: null,
            currentDurationMs: 0,
            playbackCheckInterval: null,
            colorThief: new ColorThief(),
            animationFrameId: null,
            themes: ['theme-glass', 'theme-liquid-glass', 'theme-minimal', 'theme-immersive'],
            currentThemeIndex: 0,
            audioFeatures: null,
            audioAnalysis: null,
            currentVolume: 100,
            // Settings
            canvasMode: 'none',
            preferredCanvasMode: 'none',
            portraitCoverPosition: 'left',
            currentCanvasUrl: null,
            canvasBackgroundBlurLevel: 50,
            // Lyrics State
            lyricsPosition: 'inline', // 'off', 'inline', 'right', 'card'
            currentLyrics: null,
            currentLyricIndex: -1
        };

        // --- AUTH & API (Same as before) ---
        function generateCodeVerifier() { const a=new Uint8Array(32); crypto.getRandomValues(a); return Array.from(a,b=>('0'+b.toString(16)).slice(-2)).join(''); }
        async function generateCodeChallenge(v) { const d=new TextEncoder().encode(v); const dg=await crypto.subtle.digest('SHA-256', d); return btoa(String.fromCharCode(...new Uint8Array(dg))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }
        async function redirectToSpotifyAuth() { const v = generateCodeVerifier(); sessionStorage.setItem('code_verifier', v); const c = await generateCodeChallenge(v); const p = new URLSearchParams({ response_type: 'code', client_id: CLIENT_ID, scope: SCOPES, redirect_uri: REDIRECT_URI, code_challenge_method: 'S256', code_challenge: c }); window.location.href = `https://accounts.spotify.com/authorize?${p}`; }
        async function getAccessToken(c) { const v = sessionStorage.getItem('code_verifier'); if (!v) return; const p = new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code: c, redirect_uri: REDIRECT_URI, code_verifier: v }); try { const r = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: p }); if(!r.ok) throw 0; const d = await r.json(); storeTokens(d); window.history.replaceState({}, document.title, window.location.pathname); showPlayerView(); } catch { showToast('Login failed'); showLoginView(); } }
        async function refreshAccessToken() { const r = sessionStorage.getItem('refresh_token'); if (!r) return false; const p = new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'refresh_token', refresh_token: r }); try { const res = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: p }); if(!res.ok) throw 0; const d = await res.json(); storeTokens(d); return true; } catch { showLoginView(); return false; } }
        function storeTokens(d) { sessionStorage.setItem('access_token', d.access_token); if (d.refresh_token) sessionStorage.setItem('refresh_token', d.refresh_token); sessionStorage.setItem('token_expires_in', Date.now() + d.expires_in * 1000); }
        async function spotifyApiRequest(e, o = {}) { if (!sessionStorage.getItem('access_token') || Date.now() > sessionStorage.getItem('token_expires_in')) { if (!await refreshAccessToken()) throw new Error('Auth'); } const t = sessionStorage.getItem('access_token'); const u = e.startsWith('http') ? e : `${API_BASE_URL}${e}`; const r = await fetch(u, { ...o, headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json', ...o.headers } }); if (r.status === 401 && await refreshAccessToken()) return spotifyApiRequest(e, o); if (!r.ok) throw new Error('API Error'); if (r.status === 204) return null; return r.json().catch(()=>({})); }

        // --- LYRICS LOGIC ---
        
        function setLyricsPosition(pos) {
            state.lyricsPosition = pos;
            localStorage.setItem('spotifyLyricsPosition', pos);
            
            // UI Updates for Settings List
            ui.lyricsPositionList.querySelectorAll('li').forEach(li => {
                li.classList.toggle('active', li.dataset.pos === pos);
            });

            // Layout Updates
            ui.appContainer.classList.toggle('layout-lyrics-right', pos === 'right');
            
            // Visibility toggles
            ui.lyricsInlineContainer.classList.toggle('hidden', pos !== 'inline');
            ui.lyricsSidePanel.classList.toggle('hidden', pos !== 'right');
            
            // Card mode is handled by the specific button, but if selected here, maybe open it?
            // For now, selecting 'card' just hides the others, user must click the card button.
            if (pos === 'card') {
                // Optional: Auto-open card if playing? 
                // Better: Just enable the button interaction.
            }

            // Trigger sync to ensure correct scroll position in new layout
            if (state.currentLyrics) {
                syncLyrics(null, true); // Force sync
            } else if (state.currentSongId) {
                // If song playing but no lyrics loaded yet, try loading
                fetchLyrics(state.currentArtistName, state.currentSongName, state.currentAlbumName, state.currentDurationMs);
            }
        }

        async function fetchLyrics(artist, title, album, durationMs) {
            if (state.lyricsPosition === 'off') return;

            const loadingHTML = '<p class="text-center animate-pulse mt-10 opacity-50">Buscando letra...</p>';
            renderLyricsHTML(loadingHTML); // Show loading everywhere

            const durationSec = Math.floor(durationMs / 1000);
            const params = new URLSearchParams({ title, artist, album: album || '', duration: durationSec, source: 'apple,lyricsplus,musixmatch,spotify' });

            try {
                const res = await fetch(`https://lyricsplus.prjktla.workers.dev/v2/lyrics/get?${params.toString()}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                if (!data || !data.lyrics) throw new Error('No lyrics');

                let htmlContent = '';
                if (Array.isArray(data.lyrics)) {
                    state.currentLyrics = data.lyrics;
                    const lines = data.lyrics.map((l, i) => `<div class="lyric-line" data-index="${i}" data-time="${l.time}">${l.text}</div>`).join('');
                    htmlContent = `<div class="flex flex-col items-center w-full py-10">${lines}</div>`;
                } else {
                    state.currentLyrics = null;
                    let txt = data.lyrics.replace(/\[.*?\]/g, '').trim().replace(/\n/g, '<br>');
                    htmlContent = `<div class="text-center text-lg leading-relaxed py-10 px-4">${txt}</div>`;
                }

                renderLyricsHTML(htmlContent);
                addLyricClickEvents();

            } catch (e) {
                console.error("Lyrics Error:", e);
                const errHTML = `<div class="text-center text-gray-500 mt-10"><p>Letra no disponible</p><button onclick="fetchLyrics('${artist.replace(/'/g,"\\'")}', '${title.replace(/'/g,"\\'")}', '', 0)" class="text-xs bg-white/10 px-3 py-1 mt-2 rounded">Reintentar</button></div>`;
                renderLyricsHTML(errHTML);
            }
        }

        function renderLyricsHTML(html) {
            ui.lyricsInlineContent.innerHTML = html;
            ui.lyricsSideContent.innerHTML = html;
            ui.lyricsModalContent.innerHTML = html;
        }

        function addLyricClickEvents() {
            const clickHandler = (e) => {
                const time = e.target.dataset.time;
                if (time) seekPlayback(parseInt(time));
            };
            document.querySelectorAll('.lyric-line').forEach(el => el.addEventListener('click', clickHandler));
        }

        function syncLyrics(progress, force = false) {
            if (!state.currentLyrics) return;
            
            // Find active line
            let activeIndex = -1;
            // If forced (layout change), use current index, otherwise calculate
            if (!force && progress !== null) {
                for (let i = 0; i < state.currentLyrics.length; i++) {
                    if (state.currentLyrics[i].time <= progress) activeIndex = i;
                    else break;
                }
            } else {
                activeIndex = state.currentLyricIndex;
            }

            if (activeIndex !== state.currentLyricIndex || force) {
                state.currentLyricIndex = activeIndex;
                
                const updateContainer = (container) => {
                    if (container.offsetParent === null) return; // Hidden
                    const lines = container.querySelectorAll('.lyric-line');
                    lines.forEach(l => l.classList.remove('active'));
                    if (activeIndex !== -1 && lines[activeIndex]) {
                        const line = lines[activeIndex];
                        line.classList.add('active');
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };

                updateContainer(ui.lyricsInlineContent);
                updateContainer(ui.lyricsSideContent);
                updateContainer(ui.lyricsModalContent);
            }
        }

        // --- PLAYER & CANVAS LOGIC ---
        // (Similar to previous, but optimized for layout changes)

        function updateUI(data) {
            if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
            
            if (!data || !data.item) {
                // Reset UI
                state.currentSongId = null;
                ui.songTitle.textContent = 'Nada sonando';
                ui.songArtist.textContent = 'Spotify conectado';
                ui.progressBar.style.transform = 'scaleX(0)';
                updateCanvasVisuals('none');
                return;
            }

            const { item, progress_ms, is_playing } = data;
            const artistNames = item.artists.map(a => a.name).join(' & ');

            // Song Changed
            if (item.id !== state.currentSongId) {
                state.currentSongId = item.id;
                state.currentArtistName = artistNames;
                state.currentSongName = item.name;
                state.currentAlbumName = item.album.name;
                
                ui.songTitle.textContent = item.name;
                ui.songArtist.textContent = artistNames;
                
                const cover = item.album.images[0]?.url;
                if(cover) {
                    ui.albumCover.src = cover;
                    ui.albumCover.onload = () => {
                        try {
                            const c = state.colorThief.getColor(ui.albumCover);
                            ui.progressBar.style.backgroundColor = `rgb(${c.join(',')})`;
                            ui.progressBar.style.boxShadow = `0 0 15px rgb(${c.join(',')})`;
                        } catch {}
                    };
                }

                fetchSpotifyCanvas(item.id);
                fetchLyrics(state.currentArtistName, state.currentSongName, state.currentAlbumName, item.duration_ms);
            }

            // Update Progress
            state.currentDurationMs = item.duration_ms;
            ui.timeTotal.textContent = formatTime(item.duration_ms);
            
            const songData = { initialProgress: progress_ms, startTime: Date.now(), duration: item.duration_ms, is_playing };
            state.animationFrameId = requestAnimationFrame(() => animationLoop(songData));
        }

        function animationLoop(data) {
            if (!data.is_playing) {
                ui.progressBar.style.transform = `scaleX(${data.initialProgress / data.duration})`;
                ui.timeCurrent.textContent = formatTime(data.initialProgress);
                return;
            }
            const now = Date.now();
            let progress = data.initialProgress + (now - data.startTime);
            if (progress > data.duration) progress = data.duration;

            const pct = progress / data.duration;
            ui.progressBar.style.transform = `scaleX(${pct})`;
            ui.timeCurrent.textContent = formatTime(progress);
            
            syncLyrics(progress);

            if (progress < data.duration) {
                state.animationFrameId = requestAnimationFrame(() => animationLoop(data));
            } else {
                setTimeout(fetchCurrentTrack, 500); // Song ended
            }
        }

        async function fetchSpotifyCanvas(id) {
            state.currentCanvasUrl = null;
            try {
                const res = await fetch(`https://spoticanvasapi-three.vercel.app/api/canvas?trackId=${id}`);
                const d = await res.json();
                if (d.canvasesList?.[0]?.canvasUrl) state.currentCanvasUrl = d.canvasesList[0].canvasUrl;
            } catch {}
            updateCanvasVisuals(state.preferredCanvasMode);
        }

        function updateCanvasVisuals(mode) {
            // ... (Canvas logic mostly same, just simplified call)
            let finalMode = mode;
            if (mode === 'portrait' && !state.currentCanvasUrl) finalMode = 'none';
            ui.appContainer.classList.toggle('canvas-mode-portrait', finalMode === 'portrait');
            ui.appContainer.classList.toggle('portrait-position-center', finalMode === 'portrait' && state.portraitCoverPosition === 'center');
            
            if (state.currentCanvasUrl && (mode === 'background' || mode === 'both' || mode === 'portrait')) {
                ui.canvasBgVideo.src = state.currentCanvasUrl;
                ui.canvasBgVideo.style.opacity = 1;
                ui.canvasBgVideo.play().catch(()=>{});
            } else {
                ui.canvasBgVideo.style.opacity = 0;
                ui.canvasBgVideo.pause();
            }
            
            if (state.currentCanvasUrl && (mode === 'cover' || mode === 'both' || mode === 'portrait')) {
                ui.canvasCoverVideo.src = state.currentCanvasUrl;
                ui.canvasCoverVideo.classList.remove('hidden');
                ui.albumCover.classList.add('hidden');
                ui.canvasCoverVideo.play().catch(()=>{});
            } else {
                ui.canvasCoverVideo.classList.add('hidden');
                ui.albumCover.classList.remove('hidden');
                ui.canvasCoverVideo.pause();
            }
            ui.body.style.backgroundImage = (finalMode === 'background' || finalMode === 'portrait') ? 'none' : `url(${ui.albumCover.src})`;
        }

        async function seekPlayback(ms) {
            try {
                await spotifyApiRequest(`/me/player/seek?position_ms=${Math.floor(ms)}`, { method: 'PUT' });
                setTimeout(fetchCurrentTrack, 300);
            } catch (e) { showToast('Error al buscar'); }
        }

        // --- EVENTS & INIT ---
        function formatTime(ms) { const s=Math.floor(ms/1000); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function showToast(m) { ui.toastMessage.textContent = m; ui.toast.classList.add('show'); setTimeout(()=>ui.toast.classList.remove('show'), 3000); }
        function showLoginView() { document.getElementById('login').classList.remove('hidden'); ui.playerView.classList.add('hidden'); }
        function showPlayerView() { document.getElementById('login').classList.add('hidden'); ui.playerView.classList.remove('hidden'); fetchCurrentTrack(); if (state.playbackCheckInterval) clearInterval(state.playbackCheckInterval); state.playbackCheckInterval = setInterval(fetchCurrentTrack, 3000); }

        function initialize() {
            // Auth check
            const params = new URLSearchParams(window.location.search);
            if (params.get('code')) getAccessToken(params.get('code'));
            else if (sessionStorage.getItem('access_token')) showPlayerView();
            else showLoginView();

            // Listeners
            ui.loginButton.onclick = redirectToSpotifyAuth;
            ui.openMenuButton.onclick = () => {
                ui.menuModal.classList.remove('hidden');
                document.getElementById('menu-tab-actions').classList.remove('hidden');
            };
            document.getElementById('close-menu-modal-x').onclick = () => ui.menuModal.classList.add('hidden');
            
            // Lyrics Settings Button
            ui.lyricsSettingsBtn.onclick = () => {
                ui.settingsModal.classList.remove('hidden');
            };
            ui.songLyricsButton.onclick = () => ui.lyricsModal.classList.remove('hidden');
            document.getElementById('close-lyrics-modal').onclick = () => ui.lyricsModal.classList.add('hidden');
            document.getElementById('close-background-settings-modal').onclick = () => ui.settingsModal.classList.add('hidden');

            // Settings Lists Logic
            ui.lyricsPositionList.onclick = (e) => {
                const btn = e.target.closest('.settings-btn');
                if (btn) setLyricsPosition(btn.dataset.pos);
            };
            ui.canvasModeList.onclick = (e) => {
                const btn = e.target.closest('.settings-btn');
                if (btn) {
                    state.preferredCanvasMode = btn.dataset.mode;
                    localStorage.setItem('spotifyCanvasMode', btn.dataset.mode);
                    ui.canvasModeList.querySelectorAll('li').forEach(l => l.classList.remove('active'));
                    btn.classList.add('active');
                    ui.canvasOptions.classList.toggle('hidden', btn.dataset.mode === 'none');
                    updateCanvasVisuals(btn.dataset.mode);
                }
            };

            // Progress Click
            ui.progressContainer.onclick = (e) => {
                const rect = ui.progressContainer.getBoundingClientRect();
                const pct = (e.clientX - rect.left) / rect.width;
                seekPlayback(state.currentDurationMs * pct);
            };

            // Volume
            ui.menuVolumeSlider.oninput = (e) => {
                spotifyApiRequest(`/me/player/volume?volume_percent=${e.target.value}`, { method: 'PUT' });
            };

            // Load saved settings
            const savedLyricsPos = localStorage.getItem('spotifyLyricsPosition') || 'inline';
            setLyricsPosition(savedLyricsPos);
            const savedCanvas = localStorage.getItem('spotifyCanvasMode') || 'none';
            state.preferredCanvasMode = savedCanvas;
            updateCanvasVisuals(savedCanvas);
        }

        window.onload = initialize;
    </script>
</body>
</html>
